<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="PinDrop" />
  <meta name="theme-color" content="#0a0a0f" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <link rel="icon" href="/icon-192.png" type="image/png" sizes="192x192" />
  <link rel="icon" href="/icon-512.png" type="image/png" sizes="512x512" />
  <link rel="canonical" href="https://playpindrop.app" />
  <title>PinDrop â€” Daily Geography Challenge</title>

  <!-- Open Graph / social sharing -->
  <meta property="og:type"        content="website" />
  <meta property="og:url"         content="https://playpindrop.app" />
  <meta property="og:title"       content="PinDrop â€” Daily Geography Challenge" />
  <meta property="og:description" content="Drop a pin on 5 locations across the globe. New challenge every day. How well do you know the world?" />
  <meta property="og:image"       content="https://playpindrop.app/icon-512.png" />

  <!-- Twitter / X Card -->
  <meta name="twitter:card"        content="summary" />
  <meta name="twitter:title"       content="PinDrop â€” Daily Geography Challenge" />
  <meta name="twitter:description" content="Drop a pin on 5 locations across the globe. New challenge every day." />
  <meta name="twitter:image"       content="https://playpindrop.app/icon-512.png" />

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet" />

  <!-- Set light-mode class before CSS renders to prevent flash -->
  <script>if (!window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('light-mode');</script>
  <style>
    /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0a0a0f;
      --surface:   #13131a;
      --surface2:  #1c1c27;
      --border:    rgba(255,255,255,0.07);
      --accent:    #e8ff47;
      --accent2:   #47c8ff;
      --text:      #f0f0f5;
      --muted:     rgba(240,240,245,0.45);
      --danger:    #ff5c5c;
      --success:   #47ff9e;
      --r:         16px;
      --safe-top:  env(safe-area-inset-top, 0px);
      --safe-bot:  env(safe-area-inset-bottom, 0px);
      /* Light/dark theming helpers */
      --btn-text:  #0a0a0f;        /* text on accent-coloured buttons     */
      --bg-rgb:    10, 10, 15;     /* used in rgba(var(--bg-rgb), alpha)  */
    }

    /* â”€â”€â”€ Light Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html.light-mode {
      --bg:        #ffffff;
      --surface:   #f2f2f8;
      --surface2:  #e6e6f0;
      --border:    rgba(0,0,0,0.10);
      --accent:    #47c8ff;
      --accent2:   #47c8ff;
      --text:      #111118;
      --muted:     rgba(17,17,24,0.50);
      --danger:    #dc2626;
      --success:   #059669;
      --btn-text:  #ffffff;
      --bg-rgb:    255, 255, 255;
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
    }

    /* â”€â”€â”€ Screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: opacity 0.35s ease, transform 0.35s ease;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bot);
    }
    .screen.hidden {
      opacity: 0; pointer-events: none; transform: translateY(12px);
    }

    /* â”€â”€â”€ HOME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #home {
      background: var(--bg);
      gap: 0;
    }

    .home-bg {
      position: absolute; inset: 0;
      background: radial-gradient(ellipse 80% 50% at 50% 30%, rgba(72,200,255,0.08) 0%, transparent 70%),
                  radial-gradient(ellipse 60% 40% at 80% 80%, rgba(232,255,71,0.05) 0%, transparent 60%);
      pointer-events: none;
    }

    .home-inner {
      position: relative; z-index: 1;
      display: flex; flex-direction: column;
      align-items: center;
      padding: 48px 32px;
      width: 100%;
    }

    .logo-mark {
      width: 72px; height: 72px;
      background: var(--accent);
      border-radius: 20px;
      display: flex; align-items: center; justify-content: center;
      font-size: 36px;
      margin-bottom: 24px;
      box-shadow: 0 0 40px rgba(232,255,71,0.3);
      animation: pulse-logo 3s ease-in-out infinite;
    }
    @keyframes pulse-logo {
      0%,100% { box-shadow: 0 0 40px rgba(232,255,71,0.3); }
      50%      { box-shadow: 0 0 60px rgba(232,255,71,0.5); }
    }

    .home-title {
      font-family: 'Syne', sans-serif;
      font-size: 48px; font-weight: 800;
      letter-spacing: -2px;
      line-height: 1;
      color: var(--text);
      margin-bottom: 8px;
    }

    .home-sub {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 48px;
    }

    .daily-card {
      width: 100%;
      max-width: 360px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 20px;
      margin-bottom: 28px;
    }

    .daily-label {
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .daily-date {
      font-family: 'Syne', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 16px;
    }

    .daily-progress {
      display: flex; gap: 6px;
    }
    .progress-pip {
      flex: 1; height: 4px;
      background: var(--surface2);
      border-radius: 2px;
      transition: background 0.3s;
    }
    .progress-pip.done { background: var(--accent); }

    .btn-primary {
      width: 100%; max-width: 360px;
      height: 56px;
      background: var(--accent);
      color: var(--btn-text);
      font-family: 'Syne', sans-serif;
      font-size: 16px; font-weight: 700;
      letter-spacing: 0.02em;
      border: none; border-radius: 14px;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .btn-primary:active {
      transform: scale(0.97);
      box-shadow: 0 0 0 4px rgba(232,255,71,0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 28px;
      cursor: pointer;
      margin-top: 14px;
      width: 100%; max-width: 360px;
      transition: color 0.2s, border-color 0.2s;
    }
    .btn-ghost:active { color: var(--text); border-color: rgba(255,255,255,0.2); }

    .streak-row {
      display: flex; gap: 20px;
      margin-top: 28px;
    }
    .streak-item {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
    }
    .streak-num {
      font-family: 'Syne', sans-serif;
      font-size: 28px; font-weight: 800;
      color: var(--accent);
    }
    .streak-lbl {
      font-size: 10px; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--muted);
    }

    /* â”€â”€â”€ GAME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #game { padding: 0; background: var(--bg); }

    #map {
      position: absolute; inset: 0;
      background: #111;
    }

    /* Top HUD */
    .hud {
      position: absolute;
      top: calc(var(--safe-top) + 12px);
      left: 12px; right: 12px;
      display: flex; align-items: center; gap: 10px;
      z-index: 10;
    }
    .hud-card {
      background: rgba(var(--bg-rgb),0.85);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 14px;
    }
    .hud-round {
      font-family: 'Syne', sans-serif;
      font-size: 13px; font-weight: 700;
      color: var(--text);
    }
    .hud-round span { color: var(--accent); }
    .hud-score-wrap { flex: 1; }
    .hud-score-label {
      font-size: 9px; letter-spacing: 0.15em;
      text-transform: uppercase; color: var(--muted);
    }
    .hud-score {
      font-family: 'Syne', sans-serif;
      font-size: 20px; font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }
    .hud-dots {
      display: flex; gap: 5px; align-items: center;
    }
    .hud-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--surface2);
      transition: background 0.3s;
    }
    .hud-dot.done { background: var(--accent); }
    .hud-dot.current {
      background: transparent;
      border: 2px solid var(--accent);
      animation: dot-pulse 1.2s ease-in-out infinite;
    }
    @keyframes dot-pulse {
      0%,100% { transform: scale(1); }
      50%      { transform: scale(1.3); }
    }

    /* Clue banner */
    .clue-banner {
      position: absolute;
      bottom: calc(var(--safe-bot) + 148px);
      left: 12px; right: 12px;
      background: rgba(var(--bg-rgb),0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 18px;
      z-index: 10;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .clue-label {
      font-size: 9px; letter-spacing: 0.15em;
      text-transform: uppercase; color: var(--accent);
      margin-bottom: 4px;
    }
    .clue-text {
      font-family: 'Syne', sans-serif;
      font-size: 15px; font-weight: 600;
      color: var(--text);
      line-height: 1.4;
    }

    /* Bottom action bar */
    .action-bar {
      position: absolute;
      bottom: var(--safe-bot);
      left: 0; right: 0;
      padding: 12px 16px 16px;
      background: linear-gradient(to top, rgba(var(--bg-rgb),0.98) 60%, transparent);
      z-index: 10;
      display: flex; flex-direction: column; gap: 10px;
    }

    /* Pin confirmation UI */
    .pin-confirm {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      display: flex; align-items: center; gap: 12px;
      opacity: 0; transform: translateY(8px);
      transition: opacity 0.25s, transform 0.25s;
      pointer-events: none;
    }
    .pin-confirm.visible {
      opacity: 1; transform: translateY(0); pointer-events: auto;
    }
    .pin-confirm-coords {
      flex: 1;
    }
    .pin-confirm-label {
      font-size: 9px; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--muted);
    }
    .pin-confirm-val {
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 700;
      color: var(--text);
    }
    .btn-lock {
      height: 44px; padding: 0 20px;
      background: var(--accent);
      color: var(--btn-text);
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 700;
      border: none; border-radius: 10px;
      cursor: pointer;
      transition: transform 0.15s;
      white-space: nowrap;
    }
    .btn-lock:active { transform: scale(0.95); }
    .btn-cancel-pin {
      height: 44px; padding: 0 14px;
      background: var(--surface2);
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      border: none; border-radius: 10px;
      cursor: pointer;
    }

    .tap-hint {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.05em;
      padding-bottom: 4px;
      transition: opacity 0.3s;
    }
    .tap-hint.hidden-hint { opacity: 0; }

    /* â”€â”€â”€ RESULT OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .result-overlay {
      position: absolute;
      inset: 0; z-index: 20;
      background: rgba(var(--bg-rgb),0.7);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: flex; align-items: flex-end;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .result-overlay.visible { opacity: 1; pointer-events: auto; }

    .result-sheet {
      width: 100%;
      background: var(--surface);
      border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      padding: 20px 24px calc(var(--safe-bot) + 20px);
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .result-overlay.visible .result-sheet {
      transform: translateY(0);
    }

    .result-handle {
      width: 40px; height: 4px;
      background: var(--surface2);
      border-radius: 2px;
      margin: 0 auto 20px;
    }

    .result-round-label {
      font-size: 10px; letter-spacing: 0.15em;
      text-transform: uppercase; color: var(--muted);
      text-align: center; margin-bottom: 6px;
    }
    .result-location {
      font-family: 'Syne', sans-serif;
      font-size: 22px; font-weight: 800;
      text-align: center; color: var(--text);
      margin-bottom: 20px;
    }

    .result-stats {
      display: flex; gap: 0;
      background: var(--bg);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    .result-stat {
      flex: 1;
      padding: 14px 8px;
      text-align: center;
      border-right: 1px solid var(--border);
    }
    .result-stat:last-child { border-right: none; }
    .result-stat-val {
      font-family: 'Syne', sans-serif;
      font-size: 22px; font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }
    .result-stat-lbl {
      font-size: 9px; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--muted);
      margin-top: 4px;
    }

    /* Score bar */
    .score-bar-wrap {
      margin-bottom: 20px;
    }
    .score-bar-track {
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .score-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      border-radius: 4px;
      transition: width 0.8s cubic-bezier(0.34, 1.2, 0.64, 1);
      width: 0%;
    }
    .score-bar-labels {
      display: flex; justify-content: space-between;
      margin-top: 6px;
    }
    .score-bar-lbl {
      font-size: 10px; color: var(--muted);
    }
    .score-bar-lbl.right {
      font-family: 'Syne', sans-serif;
      font-size: 12px; font-weight: 700;
      color: var(--accent);
    }

    .btn-next {
      width: 100%; height: 52px;
      background: var(--accent);
      color: var(--btn-text);
      font-family: 'Syne', sans-serif;
      font-size: 16px; font-weight: 700;
      border: none; border-radius: 14px;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .btn-next:active { transform: scale(0.97); }

    /* â”€â”€â”€ SUMMARY SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #summary {
      background: var(--bg);
      overflow-y: auto;
    }
    .summary-bg {
      position: absolute; inset: 0;
      background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(232,255,71,0.07) 0%, transparent 60%);
      pointer-events: none;
    }
    .summary-inner {
      position: relative; z-index: 1;
      width: 100%; max-width: 400px;
      padding: 32px 24px calc(var(--safe-bot) + 24px);
    }

    .summary-logo {
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 800;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .summary-title {
      font-family: 'Syne', sans-serif;
      font-size: 36px; font-weight: 800;
      letter-spacing: -1px;
      margin-bottom: 4px;
    }
    .summary-date {
      font-size: 12px; color: var(--muted);
      margin-bottom: 28px;
    }

    .final-score-ring {
      width: 140px; height: 140px;
      border-radius: 50%;
      background: conic-gradient(var(--accent) 0%, var(--accent2) 60%, var(--surface2) 60%);
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 28px;
      position: relative;
    }
    .final-score-ring::after {
      content: '';
      position: absolute;
      inset: 8px;
      background: var(--bg);
      border-radius: 50%;
    }
    .final-score-inner {
      position: relative; z-index: 1; text-align: center;
    }
    .final-score-num {
      font-family: 'Syne', sans-serif;
      font-size: 32px; font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }
    .final-score-max {
      font-size: 11px; color: var(--muted);
    }

    .round-breakdown {
      width: 100%;
      display: flex; flex-direction: column; gap: 8px;
      margin-bottom: 24px;
    }
    .round-row {
      display: flex; align-items: flex-start; gap: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-left-width: 3px;    /* colored left stripe set inline */
      border-radius: 12px;
      padding: 12px 14px;
    }
    .round-row-num {
      width: 24px; height: 24px;
      border-radius: 50%;
      background: var(--surface2);
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .round-row-body {
      flex: 1; min-width: 0;
    }
    .round-row-name {
      font-family: 'Syne', sans-serif;
      font-size: 13px; font-weight: 700;
      color: var(--text);
      margin-bottom: 3px;
    }
    .round-row-desc {
      font-size: 11px; color: var(--muted);
      line-height: 1.45;
    }
    .round-row-right {
      display: flex; flex-direction: column; align-items: flex-end;
      gap: 2px; flex-shrink: 0;
    }
    .round-row-score {
      font-family: 'Syne', sans-serif;
      font-size: 15px; font-weight: 700;
      line-height: 1;
    }
    .round-row-label {
      font-size: 9px; font-weight: 600;
      letter-spacing: 0.06em; text-transform: uppercase;
      line-height: 1;
    }
    .round-row-dist {
      font-size: 10px; color: var(--muted); margin-top: 2px;
    }

    /* Emoji share card */
    .share-card {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      font-family: 'DM Mono', monospace;
    }
    .share-card-header {
      font-size: 11px; color: var(--muted);
      margin-bottom: 8px;
    }
    .share-card-emoji {
      font-size: 22px;
      letter-spacing: 2px;
      line-height: 1.6;
    }
    .share-card-footer {
      margin-top: 8px;
      font-size: 11px; color: var(--muted);
    }

    .btn-share {
      width: 100%; height: 52px;
      background: var(--accent);
      color: var(--btn-text);
      font-family: 'Syne', sans-serif;
      font-size: 16px; font-weight: 700;
      border: none; border-radius: 14px;
      cursor: pointer;
      margin-bottom: 10px;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: transform 0.15s;
    }
    .btn-share:active { transform: scale(0.97); }

    .btn-home {
      width: 100%; height: 48px;
      background: transparent;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: 14px;
      cursor: pointer;
    }

    /* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      top: calc(var(--safe-top) + 20px);
      left: 50%; transform: translateX(-50%) translateY(-70px);
      background: var(--text);
      color: var(--bg);
      font-family: 'Syne', sans-serif;
      font-size: 13px; font-weight: 700;
      padding: 10px 20px;
      border-radius: 100px;
      white-space: nowrap;
      z-index: 100;
      transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: none;
    }
    #toast.show { transform: translateX(-50%) translateY(0); }


    /* â”€â”€â”€ REVIEW SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #review { padding: 0; background: var(--bg); }

    #review-map {
      position: absolute; inset: 0;
      background: #111;
    }

    .review-panel {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: linear-gradient(to top, rgba(var(--bg-rgb),1) 0%, rgba(var(--bg-rgb),0.97) 70%, transparent 100%);
      padding: 24px 16px calc(var(--safe-bot) + 16px);
      z-index: 10;
    }

    .review-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 14px;
    }
    .review-title-block {}
    .review-eyebrow {
      font-size: 9px; letter-spacing: 0.18em; text-transform: uppercase;
      color: var(--accent); margin-bottom: 3px;
    }
    .review-title {
      font-family: 'Syne', sans-serif;
      font-size: 20px; font-weight: 800;
      color: var(--text); line-height: 1;
    }
    .review-score-badge {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 16px;
      text-align: center;
    }
    .review-score-num {
      font-family: 'Syne', sans-serif;
      font-size: 22px; font-weight: 800;
      color: var(--accent); line-height: 1;
    }
    .review-score-denom {
      font-size: 10px; color: var(--muted);
    }

    .review-legend {
      display: flex; gap: 16px;
      margin-bottom: 14px;
    }
    .review-legend-item {
      display: flex; align-items: center; gap: 6px;
      font-size: 11px; color: var(--muted);
    }
    .legend-dot {
      width: 10px; height: 10px; border-radius: 50%;
      flex-shrink: 0;
    }
    .legend-dot.user   { background: #e8ff47; }
    .legend-dot.answer { background: #47c8ff; }

    .review-rounds {
      display: flex; gap: 6px;
      margin-bottom: 14px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 2px;
    }
    .review-rounds::-webkit-scrollbar { display: none; }

    .review-round-chip {
      flex-shrink: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      text-align: center;
      min-width: 70px;
    }
    .review-round-chip.active {
      border-color: var(--chip-score-color, var(--accent));
      background: rgba(255,255,255,0.05);
    }
    .review-chip-name {
      font-size: 10px; color: var(--muted);
      white-space: nowrap; overflow: hidden;
      text-overflow: ellipsis; max-width: 80px;
      margin-bottom: 3px;
    }
    .review-chip-score {
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 700;
      /* color set inline via scoreToColor() */
    }

    /* Description panel â€” shown when a single round is focused */
    .review-desc-panel {
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 10px;
      animation: slideUp 0.2s ease;
    }
    .review-desc-panel.visible { display: block; }
    .review-desc-loc-name {
      font-family: 'Syne', sans-serif;
      font-size: 13px; font-weight: 700;
      color: var(--text);
      margin-bottom: 5px;
    }
    .review-desc-text {
      font-size: 12px; color: var(--muted);
      line-height: 1.55;
      margin-bottom: 8px;
    }
    .review-desc-meta {
      display: flex; gap: 14px;
      font-size: 11px;
    }
    .review-desc-dist { color: var(--muted); }
    .review-desc-pts {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
    }

    .btn-share-review {
      width: 100%; height: 52px;
      background: var(--accent);
      color: var(--btn-text);
      font-family: 'Syne', sans-serif;
      font-size: 16px; font-weight: 700;
      border: none; border-radius: 14px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: transform 0.15s;
      margin-bottom: 10px;
    }
    .btn-share-review:active { transform: scale(0.97); }

    .btn-back-home {
      width: 100%; height: 44px;
      background: transparent;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
    }

    /* Home screen played state */
    .home-played-banner {
      width: 100%; max-width: 360px;
      background: rgba(232,255,71,0.07);
      border: 1px solid rgba(232,255,71,0.2);
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 12px;
      display: flex; align-items: center; gap: 12px;
    }
    .home-played-icon { font-size: 24px; }
    .home-played-text {}
    .home-played-label {
      font-size: 10px; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--accent);
      margin-bottom: 2px;
    }
    .home-played-score {
      font-family: 'Syne', sans-serif;
      font-size: 20px; font-weight: 800;
      color: var(--text);
    }

    /* Mapbox overrides */
    .mapboxgl-ctrl-bottom-left, .mapboxgl-ctrl-bottom-right,
    .mapboxgl-ctrl-top-left, .mapboxgl-ctrl-top-right { display: none !important; }
    .mapboxgl-canvas { cursor: crosshair; }
  </style>
</head>
<body>

<!-- â”€â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="home" class="screen">
  <div class="home-bg"></div>
  <div class="home-inner">
    <div class="logo-mark">ğŸ“</div>
    <h1 class="home-title">PinDrop</h1>
    <p class="home-sub">Daily Geography Challenge</p>

    <div class="daily-card">
      <div class="daily-label">Today's Challenge</div>
      <div class="daily-date" id="home-date">â€”</div>
      <div class="daily-progress" id="home-progress">
        <div class="progress-pip"></div>
        <div class="progress-pip"></div>
        <div class="progress-pip"></div>
        <div class="progress-pip"></div>
        <div class="progress-pip"></div>
      </div>
    </div>

    <button class="btn-primary" id="btn-play">Drop Today's Pins â†’</button>
    <button class="btn-ghost" id="btn-how">How to Play</button>

    <div class="streak-row">
      <div class="streak-item">
        <div class="streak-num" id="home-streak">0</div>
        <div class="streak-lbl">Day Streak</div>
      </div>
      <div class="streak-item">
        <div class="streak-num" id="home-best">â€”</div>
        <div class="streak-lbl">Best Score</div>
      </div>
      <div class="streak-item">
        <div class="streak-num" id="home-played">0</div>
        <div class="streak-lbl">Played</div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="game" class="screen hidden">
  <div id="map"></div>

  <!-- HUD -->
  <div class="hud">
    <div class="hud-card">
      <div class="hud-round">Round <span id="hud-round-num">1</span>/5</div>
    </div>
    <div class="hud-card hud-score-wrap">
      <div class="hud-score-label">Score</div>
      <div class="hud-score" id="hud-score">0</div>
    </div>
    <div class="hud-card hud-dots" id="hud-dots"></div>
  </div>

  <!-- Clue -->
  <div class="clue-banner">
    <div class="clue-label">Find this location</div>
    <div class="clue-text" id="clue-text">Loadingâ€¦</div>
  </div>

  <!-- Action bar -->
  <div class="action-bar">
    <div class="pin-confirm" id="pin-confirm">
      <div class="pin-confirm-coords">
        <div class="pin-confirm-label">Your Pin</div>
        <div class="pin-confirm-val" id="pin-coords">â€”</div>
      </div>
      <button class="btn-cancel-pin" id="btn-cancel-pin">âœ•</button>
      <button class="btn-lock" id="btn-lock">Lock It In âœ“</button>
    </div>
    <div class="tap-hint" id="tap-hint">Tap the map to drop your pin</div>
  </div>

  <!-- Round result overlay -->
  <div class="result-overlay" id="result-overlay">
    <div class="result-sheet">
      <div class="result-handle"></div>
      <div class="result-round-label" id="result-round-label">Round 1 of 5</div>
      <div class="result-location" id="result-location">â€”</div>
      <div class="result-quality" id="result-quality" style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;margin:-4px 0 12px;"></div>

      <div class="result-stats">
        <div class="result-stat">
          <div class="result-stat-val" id="result-dist">â€”</div>
          <div class="result-stat-lbl">Away</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-val" id="result-pts">â€”</div>
          <div class="result-stat-lbl">Points</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-val" id="result-total">â€”</div>
          <div class="result-stat-lbl">Total</div>
        </div>
      </div>

      <div class="score-bar-wrap">
        <div class="score-bar-track">
          <div class="score-bar-fill" id="score-bar-fill"></div>
        </div>
        <div class="score-bar-labels">
          <span class="score-bar-lbl">0</span>
          <span class="score-bar-lbl right" id="score-bar-pct">â€”</span>
          <span class="score-bar-lbl">200</span>
        </div>
      </div>

      <div id="result-description" style="
        font-size: 13px;
        line-height: 1.55;
        color: rgba(240,240,245,0.55);
        font-family: 'DM Mono', monospace;
        font-weight: 300;
        margin: -8px 0 18px;
        padding: 10px 14px;
        background: rgba(255,255,255,0.04);
        border-radius: 10px;
        border-left: 2px solid rgba(255,255,255,0.12);
        text-align: left;
      "></div>

      <button class="btn-next" id="btn-next">Next Round â†’</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="summary" class="screen hidden">
  <div class="summary-bg"></div>
  <div class="summary-inner">
    <div class="summary-logo">PinDrop</div>
    <h2 class="summary-title">Daily<br/>Complete.</h2>
    <div class="summary-date" id="summary-date">â€”</div>

    <div class="final-score-ring" id="score-ring">
      <div class="final-score-inner">
        <div class="final-score-num" id="final-score">0</div>
        <div class="final-score-max">/ 1000</div>
      </div>
    </div>

    <div class="round-breakdown" id="round-breakdown"></div>

    <div class="share-card">
      <div class="share-card-header">ğŸ“ PinDrop Â· <span id="share-day">Day #1</span></div>
      <div class="share-card-emoji" id="share-emojis"></div>
      <div class="share-card-footer" id="share-score-line"></div>
    </div>

    <button class="btn-share" id="btn-share">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
      </svg>
      Share My Score
    </button>
    <button class="btn-home" id="btn-home-from-summary">â† Back to Home</button>
  </div>
</div>


<!-- â”€â”€â”€ REVIEW (already played) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="review" class="screen hidden">
  <div id="review-map"></div>

  <div class="review-panel">
    <div class="review-header">
      <div class="review-title-block">
        <div class="review-eyebrow">Today's Results</div>
        <div class="review-title" id="review-title">â€”</div>
      </div>
      <div class="review-score-badge">
        <div class="review-score-num" id="review-score-num">â€”</div>
        <div class="review-score-denom">/ 1000</div>
      </div>
    </div>

    <div class="review-legend">
      <div class="review-legend-item">
        <div class="legend-dot user"></div>
        <span>Your guess</span>
      </div>
      <div class="review-legend-item">
        <div class="legend-dot answer"></div>
        <span>Actual location</span>
      </div>
    </div>

    <div class="review-rounds" id="review-rounds"></div>

    <!-- Shown when a single round chip is selected -->
    <div class="review-desc-panel" id="review-desc-panel"></div>

    <button class="btn-share-review" id="btn-share-review">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
      </svg>
      Challenge Your Friends
    </button>
    <button class="btn-back-home" id="btn-back-home-review">â† Back to Home</button>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIGURATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// âš ï¸  REPLACE WITH YOUR MAPBOX TOKEN
const MAPBOX_TOKEN = '__MAPBOX_TOKEN__';
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const ROUNDS_PER_GAME = 5;
const MAX_SCORE_PER_ROUND = 200;

// Detect system color scheme once at startup
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
const MAP_STYLE   = prefersDark
  ? 'mapbox://styles/mapbox/dark-v11'
  : 'mapbox://styles/mapbox/light-v11';

let map = null;
let state = {
  round: 0,
  totalScore: 0,
  roundResults: [],
  pendingPin: null,
  pinMarker: null,
  answerMarker: null,
  answerLine: null,
  gameComplete: false,
  lockingPin: false,
  currentClue: null,
};


// Day counter for share text (non-sensitive)
function getDayNumber() {
  const epoch = new Date('2026-02-27T00:00:00Z'); // App launch day
  return Math.floor((new Date() - epoch) / 86400000) + 1;
}

// Returns the user's LOCAL date as "YYYY-MM-DD" (used to sync daily seed with server)
function getLocalDateStr() {
  const d = new Date();
  return d.getFullYear() + '-' +
    String(d.getMonth() + 1).padStart(2, '0') + '-' +
    String(d.getDate()).padStart(2, '0');
}
function formatDist(km) {
  if (km < 1) return `${Math.round(km * 1000)}m`;
  if (km >= 1000) return `${(km/1000).toFixed(1)}k km`;
  return `${Math.round(km)} km`;
}

function scoreToEmoji(pts) {
  if (pts >= 190) return 'ğŸ¯'; // Exact
  if (pts >= 150) return 'ğŸŸ¢'; // Great
  if (pts >= 100) return 'ğŸŸ¡'; // Good
  if (pts >= 50)  return 'ğŸŸ '; // Okay
  if (pts >= 20)  return 'ğŸ”´'; // Bad
  return 'âš«';                  // Way Off
}

function scoreToLabel(pts) {
  if (pts >= 190) return 'Exact!';
  if (pts >= 150) return 'Great';
  if (pts >= 100) return 'Good';
  if (pts >= 50)  return 'Okay';
  if (pts >= 20)  return 'Bad';
  return 'Way Off';
}

function scoreToColor(pts) {
  // Use darker, higher-contrast colours in light mode
  const light = document.documentElement.classList.contains('light-mode');
  if (pts >= 190) return light ? '#0891b2' : '#47ffff';  // cyan   / teal
  if (pts >= 150) return light ? '#059669' : '#47ff9e';  // green  / emerald
  if (pts >= 100) return light ? '#ca8a04' : '#e8ff47';  // yellow / amber
  if (pts >= 50)  return light ? '#ea580c' : '#ffaa47';  // orange
  if (pts >= 20)  return light ? '#dc2626' : '#ff8c47';  // red-orange / red
  return light ? '#b91c1c' : '#ff5c5c';                  // dark red
}

function showToast(msg, duration = 2000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

function formatDate(d) {
  return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const STORAGE_KEY = 'pindrop_v1';

function loadStorage() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  } catch { return {}; }
}

function saveStorage(data) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch {}
}

function getTodayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}

function updateStats(finalScore) {
  const store = loadStorage();
  const today = getTodayKey();
  store.played = (store.played || 0) + 1;
  store.bestScore = Math.max(store.bestScore || 0, finalScore);
  store.lastScore = finalScore;
  // Streak
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yKey = `${yesterday.getFullYear()}-${yesterday.getMonth()+1}-${yesterday.getDate()}`;
  if (store.lastPlayedDay === yKey) {
    store.streak = (store.streak || 0) + 1;
  } else if (store.lastPlayedDay !== today) {
    store.streak = 1;
  }
  store.lastPlayedDay = today;
  saveStorage(store);
}

function hasPlayedToday() {
  const store = loadStorage();
  return store.lastPlayedDay === getTodayKey();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCREENS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => {
    s.classList.toggle('hidden', s.id !== id);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HOME SCREEN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initHome() {
  const store = loadStorage();
  document.getElementById('home-date').textContent = formatDate(new Date());
  document.getElementById('home-streak').textContent = store.streak || 0;
  document.getElementById('home-best').textContent = store.bestScore ? store.bestScore.toLocaleString() : 'â€”';
  document.getElementById('home-played').textContent = store.played || 0;

  const played = hasPlayedToday();
  const btn = document.getElementById('btn-play');

  // Progress pips
  const pips = document.querySelectorAll('#home-progress .progress-pip');
  if (played && store.lastRoundResults) {
    store.lastRoundResults.forEach((_, i) => pips[i]?.classList.add('done'));
  }
  // Remove any stale played-state UI from previous initHome calls
  const existingBanner = document.getElementById('played-banner');
  if (existingBanner) existingBanner.remove();
  const existingViewBtn = document.getElementById('btn-view-results');
  if (existingViewBtn) existingViewBtn.remove();
  const existingCountdown = document.getElementById('comeback-msg');
  if (existingCountdown) existingCountdown.remove();
  btn.style.display = 'block';

  if (played) {
    // Hide the play button
    btn.style.display = 'none';

    // Score banner
    const banner = document.createElement('div');
    banner.id = 'played-banner';
    banner.className = 'home-played-banner';
    banner.style.maxWidth = '360px';
    banner.innerHTML = `
      <div class="home-played-icon">âœ…</div>
      <div class="home-played-text">
        <div class="home-played-label">Today's Score</div>
        <div class="home-played-score">${store.lastScore || 0} <span style="font-size:14px;color:var(--muted);font-family:'DM Mono',monospace;font-weight:400">/ 1000</span></div>
      </div>
    `;
    btn.parentNode.insertBefore(banner, btn);

    // View Results button
    const viewBtn = document.createElement('button');
    viewBtn.id = 'btn-view-results';
    viewBtn.className = 'btn-primary';
    viewBtn.style.maxWidth = '360px';
    viewBtn.textContent = 'View My Results â†’';
    viewBtn.addEventListener('click', showReview);
    btn.parentNode.insertBefore(viewBtn, btn);

    // Countdown
    const now = new Date();
    const midnight = new Date(now); midnight.setHours(24,0,0,0);
    const h = Math.floor((midnight - now) / 3600000);
    const m = Math.floor(((midnight - now) % 3600000) / 60000);
    const countdown = document.createElement('p');
    countdown.id = 'comeback-msg';
    countdown.style.cssText = 'font-size:11px;color:rgba(240,240,245,0.35);text-align:center;letter-spacing:0.05em;margin-top:6px;';
    countdown.textContent = `Next challenge in ${h}h ${m}m`;
    btn.parentNode.insertBefore(countdown, btn);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAP / GAME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Applies water/land contrast colours and (optionally) city labels
 * to a Mapbox map instance, adapting to light or dark mode.
 * Must be called inside a 'load' or 'style.load' event handler.
 */
function applyMapStyle(m, isDark, cityLabels = true) {
  // â”€â”€ Contrast colours â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  for (const layer of m.getStyle().layers) {
    const lid = layer.id.toLowerCase();
    const isWater = lid.includes('water') || lid.includes('waterway') || lid.includes('ocean');
    if (isDark) {
      // Land â†’ lighter slate so it stands out; water â†’ near-black to match app bg
      if (layer.type === 'background') {
        try { m.setPaintProperty(layer.id, 'background-color', '#3a3f52'); } catch(e) {}
      } else if (isWater && layer.type === 'fill') {
        try { m.setPaintProperty(layer.id, 'fill-color', '#05070f'); } catch(e) {}
      } else if (isWater && layer.type === 'line') {
        try { m.setPaintProperty(layer.id, 'line-color', '#040609'); } catch(e) {}
      }
    } else {
      // Light mode: boost water to a vivid sky-blue for clear contrast
      if (isWater && layer.type === 'fill') {
        try { m.setPaintProperty(layer.id, 'fill-color', '#7ab8d9'); } catch(e) {}
      } else if (isWater && layer.type === 'line') {
        try { m.setPaintProperty(layer.id, 'line-color', '#5ea3c8'); } catch(e) {}
      }
    }
  }

  // â”€â”€ Strip all symbol/label layers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  for (const layer of m.getStyle().layers) {
    if (layer.type === 'symbol') m.removeLayer(layer.id);
  }

  // â”€â”€ Add back major city labels (gameplay map only) â”€â”€â”€â”€
  if (!cityLabels) return;

  const labelColor = isDark ? 'rgba(255,255,255,0.60)' : 'rgba(15,35,70,0.85)';
  const haloColor  = isDark ? 'rgba(8,8,18,0.85)'     : 'rgba(255,255,255,0.85)';

  const cityLabelLayout = {
    'text-field': ['get', 'name_en'],
    'text-font': ['DIN Pro Medium', 'Arial Unicode MS Regular'],
    'text-size': ['interpolate', ['linear'], ['zoom'], 1, 9, 5, 13],
    'text-max-width': 8,
    'text-padding': 4,
    'symbol-sort-key': ['-', 0, ['coalesce', ['get', 'population'], 0]],
  };
  const cityLabelPaint = {
    'text-color': labelColor,
    'text-halo-color': haloColor,
    'text-halo-width': 1.5,
  };

  // Global mega-cities: population > 5M
  m.addLayer({
    id: 'city-labels-global',
    type: 'symbol',
    source: 'composite',
    'source-layer': 'place_label',
    filter: ['all',
      ['==', ['get', 'type'], 'city'],
      ['>=', ['coalesce', ['get', 'population'], 0], 5000000],
    ],
    layout: cityLabelLayout,
    paint: cityLabelPaint,
  });

  // Europe & North America: cities > 2M
  const europaNAGeoJSON = {
    type: 'Feature',
    geometry: {
      type: 'MultiPolygon',
      coordinates: [
        [[[-30,34],[50,34],[50,72],[-30,72],[-30,34]]],         // Europe
        [[[-170,15],[-50,15],[-50,75],[-170,75],[-170,15]]],   // North America
      ]
    }
  };
  m.addLayer({
    id: 'city-labels-eu-na',
    type: 'symbol',
    source: 'composite',
    'source-layer': 'place_label',
    filter: ['all',
      ['==', ['get', 'type'], 'city'],
      ['>=', ['coalesce', ['get', 'population'], 0], 2000000],
      ['<',  ['coalesce', ['get', 'population'], 0], 5000000],
      ['within', europaNAGeoJSON],
    ],
    layout: cityLabelLayout,
    paint: cityLabelPaint,
  });
}

function initMap() {
  if (map) return; // already initialized

  mapboxgl.accessToken = MAPBOX_TOKEN;

  map = new mapboxgl.Map({
    container: 'map',
    style: MAP_STYLE,
    center: [15, 25],
    zoom: 1.8,
    minZoom: 1,
    maxZoom: 12,
    projection: 'mercator',
    attributionControl: false,
    pitchWithRotate: false,
    dragRotate: false,
  });

  map.on('load', () => {
    applyMapStyle(map, prefersDark);
    map.on('click', onMapClick);
  });
}

function onMapClick(e) {
  if (document.getElementById('result-overlay').classList.contains('visible')) return;

  const { lng, lat } = e.lngLat;

  // Remove old pending marker
  if (state.pinMarker) { state.pinMarker.remove(); state.pinMarker = null; }

  // Create custom marker element
  const el = document.createElement('div');
  el.style.cssText = `
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; filter: drop-shadow(0 4px 12px rgba(232,255,71,0.5));
    animation: pin-drop 0.4s cubic-bezier(0.34,1.56,0.64,1);
  `;
  el.innerHTML = `<svg width="36" height="48" viewBox="0 0 36 48" fill="none">
    <path d="M18 0C8.06 0 0 8.06 0 18c0 13.5 18 30 18 30s18-16.5 18-30C36 8.06 27.94 0 18 0z" fill="#e8ff47"/>
    <circle cx="18" cy="18" r="8" fill="#0a0a0f"/>
  </svg>`;

  const style = document.createElement('style');
  style.textContent = `@keyframes pin-drop {
    0% { transform: translateY(-20px) scale(0.7); opacity: 0; }
    100% { transform: translateY(0) scale(1); opacity: 1; }
  }`;
  document.head.appendChild(style);

  state.pinMarker = new mapboxgl.Marker({ element: el, anchor: 'bottom' })
    .setLngLat([lng, lat])
    .addTo(map);

  state.pendingPin = { lat, lng };

  // Update UI
  document.getElementById('pin-confirm').classList.add('visible');
  document.getElementById('tap-hint').classList.add('hidden-hint');
  document.getElementById('pin-coords').textContent =
    `${lat.toFixed(3)}Â°, ${lng.toFixed(3)}Â°`;

  // Haptic
  if (navigator.vibrate) navigator.vibrate(10);
}

async function lockPin() {
  if (!state.pendingPin || state.lockingPin) return;
  state.lockingPin = true;  // prevent double-submit
  if (navigator.vibrate) navigator.vibrate([20, 10, 20]);

  const { lat, lng } = state.pendingPin;

  let name, description, targetLat, targetLng, distKm, pts;
  try {
    const res = await fetch('/api/game', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'score', round: state.round, guessLat: lat, guessLng: lng, date: getLocalDateStr() }),
    });
    if (!res.ok) throw new Error('Network error');
    ({ name, description, targetLat, targetLng, distKm, pts } = await res.json());
  } catch (e) {
    state.lockingPin = false;
    showToast('Failed to submit guess â€” check your connection', 3000);
    return;
  }
  state.lockingPin = false;
  state.totalScore += pts;

  state.roundResults.push({ name, description, pts, distKm, userLat: lat, userLng: lng, targetLat, targetLng });

  // Show answer marker
  const ansEl = document.createElement('div');
  ansEl.style.cssText = `
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    filter: drop-shadow(0 4px 12px rgba(71,200,255,0.6));
  `;
  ansEl.innerHTML = `<svg width="36" height="48" viewBox="0 0 36 48" fill="none">
    <path d="M18 0C8.06 0 0 8.06 0 18c0 13.5 18 30 18 30s18-16.5 18-30C36 8.06 27.94 0 18 0z" fill="#47c8ff"/>
    <circle cx="18" cy="18" r="8" fill="#0a0a0f"/>
  </svg>`;

  state.answerMarker = new mapboxgl.Marker({ element: ansEl, anchor: 'bottom' })
    .setLngLat([targetLng, targetLat])
    .addTo(map);

  // Draw line
  if (map.getSource('answer-line')) {
    map.removeLayer('answer-line-layer');
    map.removeSource('answer-line');
  }
  map.addSource('answer-line', {
    type: 'geojson',
    data: {
      type: 'Feature',
      geometry: {
        type: 'LineString',
        coordinates: [[lng, lat], [targetLng, targetLat]]
      }
    }
  });
  map.addLayer({
    id: 'answer-line-layer',
    type: 'line',
    source: 'answer-line',
    paint: {
      'line-color': scoreToColor(pts),   // colour reflects this round's score
      'line-width': 2.5,
      'line-dasharray': [4, 2],
      'line-opacity': 0.85
    }
  });

  // Fit map to show both points
  const bounds = new mapboxgl.LngLatBounds()
    .extend([lng, lat])
    .extend([targetLng, targetLat]);
  map.fitBounds(bounds, { padding: 80, duration: 800 });

  // Show result overlay
  showRoundResult(name, description, distKm, pts);
}

function showRoundResult(name, description, distKm, pts) {
  document.getElementById('result-round-label').textContent =
    `Round ${state.round + 1} of ${ROUNDS_PER_GAME}`;
  document.getElementById('result-location').textContent = name;
  const qualityEl = document.getElementById('result-quality');
  qualityEl.textContent = scoreToLabel(pts);
  qualityEl.style.color = scoreToColor(pts);
  document.getElementById('result-description').textContent = description;
  document.getElementById('result-dist').textContent = formatDist(distKm);
  document.getElementById('result-pts').textContent = pts;
  document.getElementById('result-total').textContent = state.totalScore;
  document.getElementById('hud-score').textContent = state.totalScore;

  const pct = pts / MAX_SCORE_PER_ROUND * 100;
  document.getElementById('score-bar-pct').textContent = `${pts} pts`;

  setTimeout(() => {
    document.getElementById('result-overlay').classList.add('visible');
    // Animate bar
    setTimeout(() => {
      document.getElementById('score-bar-fill').style.width = pct + '%';
    }, 100);
  }, 600);

  // Update next button text
  const isLast = state.round === ROUNDS_PER_GAME - 1;
  document.getElementById('btn-next').textContent = isLast ? 'See Results â†’' : 'Next Round â†’';
}

function nextRound() {
  // Clean up map
  if (state.pinMarker) { state.pinMarker.remove(); state.pinMarker = null; }
  if (state.answerMarker) { state.answerMarker.remove(); state.answerMarker = null; }
  if (map.getLayer('answer-line-layer')) {
    map.removeLayer('answer-line-layer');
    map.removeSource('answer-line');
  }

  document.getElementById('result-overlay').classList.remove('visible');
  document.getElementById('pin-confirm').classList.remove('visible');
  document.getElementById('tap-hint').classList.remove('hidden-hint');
  document.getElementById('score-bar-fill').style.width = '0%';
  state.pendingPin = null;

  const isLast = state.round === ROUNDS_PER_GAME - 1;

  if (isLast) {
    finishGame();
    return;
  }

  state.round++;
  loadRound();
}

async function loadRound() {
  // Fetch today's clue for this round from the server (no coordinates exposed)
  try {
    const res = await fetch(`/api/game?action=clue&round=${state.round}&date=${getLocalDateStr()}`);
    if (!res.ok) throw new Error('Network error');
    const data = await res.json();
    state.currentClue = data.name;
    document.getElementById('hud-round-num').textContent = state.round + 1;
    document.getElementById('clue-text').textContent = data.name;
  } catch (e) {
    showToast('Failed to load round â€” check your connection', 3000);
    return;
  }

  // Update dots
  const dotsEl = document.getElementById('hud-dots');
  dotsEl.innerHTML = '';
  for (let i = 0; i < ROUNDS_PER_GAME; i++) {
    const dot = document.createElement('div');
    dot.className = 'hud-dot';
    if (i < state.round) dot.classList.add('done');
    else if (i === state.round) dot.classList.add('current');
    dotsEl.appendChild(dot);
  }

  // Reset map view
  map.flyTo({ center: [15, 25], zoom: 1.8, duration: 800 });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUMMARY / FINISH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function finishGame() {
  updateStats(state.totalScore);

  // Save for home screen progress
  const store = loadStorage();
  store.lastRoundResults = state.roundResults;
  saveStorage(store);

  buildSummary();
  showScreen('summary');
}

function buildSummary() {
  const today = new Date();
  document.getElementById('summary-date').textContent = formatDate(today);
  document.getElementById('final-score').textContent = state.totalScore;
  document.getElementById('share-day').textContent = `Day #${getDayNumber()}`;

  // Ring fill (conic gradient)
  const pct = state.totalScore / (MAX_SCORE_PER_ROUND * ROUNDS_PER_GAME);
  const deg = Math.round(pct * 360);
  document.getElementById('score-ring').style.background =
    `conic-gradient(var(--accent) 0deg, var(--accent2) ${deg}deg, var(--surface2) ${deg}deg)`;

  // Round breakdown
  const bk = document.getElementById('round-breakdown');
  bk.innerHTML = '';
  state.roundResults.forEach((r, i) => {
    const row = document.createElement('div');
    row.className = 'round-row';
    const color = scoreToColor(r.pts);
    row.style.borderLeftColor = color;
    row.innerHTML = `
      <div class="round-row-num" style="background:${color}22;color:${color}">${i+1}</div>
      <div class="round-row-body">
        <div class="round-row-name">${r.name}</div>
        ${r.description ? `<div class="round-row-desc">${r.description}</div>` : ''}
      </div>
      <div class="round-row-right">
        <div class="round-row-score" style="color:${color}">${r.pts}</div>
        <div class="round-row-label" style="color:${color}">${scoreToLabel(r.pts)}</div>
        <div class="round-row-dist">${formatDist(r.distKm)}</div>
      </div>
    `;
    bk.appendChild(row);
  });

  // Share card
  const emojis = state.roundResults.map(r => scoreToEmoji(r.pts)).join(' ');
  document.getElementById('share-emojis').textContent = emojis;
  document.getElementById('share-score-line').textContent =
    `${state.totalScore} / 1000`;
}

function getShareText() {
  const day = getDayNumber();
  const store = loadStorage();
  const results = (state.roundResults && state.roundResults.length > 0)
    ? state.roundResults
    : (store.lastRoundResults || []);
  const score = (state.roundResults && state.roundResults.length > 0)
    ? state.totalScore
    : (store.lastScore || 0);
  const emojis = results.map(r => scoreToEmoji(r.pts)).join(' ');
  return `ğŸ“ PinDrop Day #${day}\n${emojis}\n${score} / 1000\n${window.location.origin}`;
}

async function shareScore() {
  const text = getShareText();
  if (navigator.share) {
    try {
      await navigator.share({ text });
    } catch (e) {
      if (e.name !== 'AbortError') copyToClipboard(text);
    }
  } else {
    copyToClipboard(text);
  }
}

function copyToClipboard(text) {
  navigator.clipboard?.writeText(text).then(() => {
    showToast('Score copied to clipboard!');
  }).catch(() => {
    showToast('Copy failed â€” try manually');
  });
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REVIEW MODE (already played today)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let reviewMap = null;
let reviewMarkers = [];
let reviewFocusedRound = -1; // -1 = show all

function initReviewMap(results) {
  if (reviewMap) {
    // Already initialized â€” just refresh markers
    populateReviewMap(results);
    return;
  }

  reviewMap = new mapboxgl.Map({
    container: 'review-map',
    style: MAP_STYLE,
    center: [15, 25],
    zoom: 1.4,
    minZoom: 1,
    maxZoom: 10,
    projection: 'mercator',
    attributionControl: false,
    pitchWithRotate: false,
    dragRotate: false,
    interactive: true,
  });

  reviewMap.on('load', () => {
    applyMapStyle(reviewMap, prefersDark, /* cityLabels= */ false);
    populateReviewMap(results);
  });
}

function clearReviewMarkers() {
  reviewMarkers.forEach(m => m.remove());
  reviewMarkers = [];
  if (reviewMap) {
    ['rv-lines'].forEach(id => {
      if (reviewMap.getLayer(id)) reviewMap.removeLayer(id);
      if (reviewMap.getSource(id)) reviewMap.removeSource(id);
    });
    // Remove individual line layers
    for (let i = 0; i < 5; i++) {
      if (reviewMap.getLayer(`rv-line-${i}`)) reviewMap.removeLayer(`rv-line-${i}`);
      if (reviewMap.getSource(`rv-line-${i}`)) reviewMap.removeSource(`rv-line-${i}`);
    }
  }
}

function populateReviewMap(results) {
  clearReviewMarkers();

  const bounds = new mapboxgl.LngLatBounds();
  const focus = reviewFocusedRound;

  results.forEach((r, i) => {
    if (focus !== -1 && focus !== i) return;

    const alpha = focus === -1 ? 1 : 1;

    // User marker (yellow)
    const uEl = document.createElement('div');
    uEl.style.cssText = `width:32px;height:42px;display:flex;align-items:center;justify-content:center;filter:drop-shadow(0 3px 8px rgba(232,255,71,0.5));`;
    uEl.innerHTML = `<svg width="26" height="36" viewBox="0 0 36 48" fill="none">
      <path d="M18 0C8.06 0 0 8.06 0 18c0 13.5 18 30 18 30s18-16.5 18-30C36 8.06 27.94 0 18 0z" fill="#e8ff47"/>
      <circle cx="18" cy="18" r="7" fill="#0a0a0f"/>
      <text x="18" y="22" text-anchor="middle" fill="#e8ff47" font-size="10" font-family="Syne,sans-serif" font-weight="800">${i+1}</text>
    </svg>`;
    const uM = new mapboxgl.Marker({ element: uEl, anchor: 'bottom' })
      .setLngLat([r.userLng, r.userLat])
      .addTo(reviewMap);
    reviewMarkers.push(uM);

    // Answer marker (blue)
    const aEl = document.createElement('div');
    aEl.style.cssText = `width:32px;height:42px;display:flex;align-items:center;justify-content:center;filter:drop-shadow(0 3px 8px rgba(71,200,255,0.5));`;
    aEl.innerHTML = `<svg width="26" height="36" viewBox="0 0 36 48" fill="none">
      <path d="M18 0C8.06 0 0 8.06 0 18c0 13.5 18 30 18 30s18-16.5 18-30C36 8.06 27.94 0 18 0z" fill="#47c8ff"/>
      <circle cx="18" cy="18" r="7" fill="#0a0a0f"/>
      <text x="18" y="22" text-anchor="middle" fill="#47c8ff" font-size="10" font-family="Syne,sans-serif" font-weight="800">${i+1}</text>
    </svg>`;
    const aM = new mapboxgl.Marker({ element: aEl, anchor: 'bottom' })
      .setLngLat([r.targetLng, r.targetLat])
      .addTo(reviewMap);
    reviewMarkers.push(aM);

    // Line between them â€” coloured by score for instant visual feedback
    const lineColor = scoreToColor(r.pts);
    reviewMap.addSource(`rv-line-${i}`, {
      type: 'geojson',
      data: {
        type: 'Feature',
        geometry: { type: 'LineString', coordinates: [[r.userLng, r.userLat], [r.targetLng, r.targetLat]] }
      }
    });
    reviewMap.addLayer({
      id: `rv-line-${i}`,
      type: 'line',
      source: `rv-line-${i}`,
      paint: { 'line-color': lineColor, 'line-width': 2.5, 'line-dasharray': [4, 2], 'line-opacity': 0.85 }
    });

    bounds.extend([r.userLng, r.userLat]);
    bounds.extend([r.targetLng, r.targetLat]);
  });

  // Fit map
  if (!bounds.isEmpty()) {
    reviewMap.fitBounds(bounds, { padding: { top: 60, bottom: 280, left: 40, right: 40 }, duration: 600, maxZoom: 7 });
  }
}

function showReview() {
  const store = loadStorage();
  const results = store.lastRoundResults;
  if (!results || results.length === 0) return;

  const score = store.lastScore || 0;
  reviewFocusedRound = -1;

  document.getElementById('review-score-num').textContent = score;
  document.getElementById('review-title').textContent = formatDate(new Date());

  // Build round chips
  const chipsEl = document.getElementById('review-rounds');
  chipsEl.innerHTML = '';
  const descPanel = document.getElementById('review-desc-panel');

  function showDescPanel(r) {
    if (!r || !descPanel) return;
    const color = scoreToColor(r.pts);
    const label = scoreToLabel(r.pts);
    descPanel.innerHTML = `
      <div class="review-desc-loc-name">${r.name}</div>
      <div class="review-desc-text">${r.description || ''}</div>
      <div class="review-desc-meta">
        <span class="review-desc-dist">${formatDist(r.distKm)} away</span>
        <span class="review-desc-pts" style="color:${color}">${r.pts} pts Â· ${label}</span>
      </div>`;
    descPanel.classList.add('visible');
  }

  function hideDescPanel() {
    if (descPanel) descPanel.classList.remove('visible');
  }

  // "All" chip
  const allChip = document.createElement('div');
  allChip.className = 'review-round-chip active';
  allChip.innerHTML = `<div class="review-chip-name">All Rounds</div><div class="review-chip-score">${score}</div>`;
  allChip.addEventListener('click', () => {
    reviewFocusedRound = -1;
    document.querySelectorAll('.review-round-chip').forEach(c => c.classList.remove('active'));
    allChip.classList.add('active');
    hideDescPanel();
    populateReviewMap(results);
  });
  chipsEl.appendChild(allChip);

  results.forEach((r, i) => {
    const chip = document.createElement('div');
    chip.className = 'review-round-chip';
    const shortName = r.name.split(',')[0];
    const color = scoreToColor(r.pts);
    chip.style.setProperty('--chip-score-color', color);
    chip.innerHTML = `
      <div class="review-chip-name">${shortName}</div>
      <div class="review-chip-score" style="color:${color}">${r.pts}</div>`;
    chip.addEventListener('click', () => {
      reviewFocusedRound = i;
      document.querySelectorAll('.review-round-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      showDescPanel(r);
      populateReviewMap(results);
    });
    chipsEl.appendChild(chip);
  });

  showScreen('review');
  initReviewMap(results);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// START GAME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startGame() {
  if (hasPlayedToday()) {
    showToast("You've already played today â€” come back tomorrow!", 3000);
    return;
  }
  state = {
    round: 0,
    totalScore: 0,
    roundResults: [],
    pendingPin: null,
    pinMarker: null,
    answerMarker: null,
    answerLine: null,
      gameComplete: false,
    lockingPin: false,
    currentClue: null,
  };

  showScreen('game');
  initMap();
  map.once('load', () => loadRound());
  if (map._loaded) loadRound();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EVENT LISTENERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('btn-play').addEventListener('click', startGame);

document.getElementById('btn-how').addEventListener('click', () => {
  showToast('Tap the map â†’ Lock It In â†’ 5 rounds, score by accuracy!', 3000);
});

document.getElementById('btn-lock').addEventListener('click', lockPin);

document.getElementById('btn-cancel-pin').addEventListener('click', () => {
  if (state.pinMarker) { state.pinMarker.remove(); state.pinMarker = null; }
  state.pendingPin = null;
  document.getElementById('pin-confirm').classList.remove('visible');
  document.getElementById('tap-hint').classList.remove('hidden-hint');
});

document.getElementById('btn-next').addEventListener('click', nextRound);

document.getElementById('btn-share').addEventListener('click', shareScore);

document.getElementById('btn-home-from-summary').addEventListener('click', () => {
  initHome();
  showScreen('home');
});

document.getElementById('btn-share-review').addEventListener('click', shareScore);

document.getElementById('btn-back-home-review').addEventListener('click', () => {
  initHome();
  showScreen('home');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

mapboxgl.accessToken = MAPBOX_TOKEN;
initHome();
showScreen('home');
</script>
</body>
</html>
