<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="PinDrop" />
  <meta name="theme-color" content="#0a0a0f" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <title>PinDrop</title>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet" />

  <style>
    /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0a0a0f;
      --surface:   #13131a;
      --surface2:  #1c1c27;
      --border:    rgba(255,255,255,0.07);
      --accent:    #e8ff47;
      --accent2:   #47c8ff;
      --text:      #f0f0f5;
      --muted:     rgba(240,240,245,0.45);
      --danger:    #ff5c5c;
      --success:   #47ff9e;
      --r:         16px;
      --safe-top:  env(safe-area-inset-top, 0px);
      --safe-bot:  env(safe-area-inset-bottom, 0px);
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      user-select: none;
    }

    /* â”€â”€â”€ Screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: opacity 0.35s ease, transform 0.35s ease;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bot);
    }
    .screen.hidden {
      opacity: 0; pointer-events: none; transform: translateY(12px);
    }

    /* â”€â”€â”€ HOME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #home {
      background: var(--bg);
      gap: 0;
    }

    .home-bg {
      position: absolute; inset: 0;
      background: radial-gradient(ellipse 80% 50% at 50% 30%, rgba(72,200,255,0.08) 0%, transparent 70%),
                  radial-gradient(ellipse 60% 40% at 80% 80%, rgba(232,255,71,0.05) 0%, transparent 60%);
      pointer-events: none;
    }

    .home-inner {
      position: relative; z-index: 1;
      display: flex; flex-direction: column;
      align-items: center;
      padding: 48px 32px;
      width: 100%;
    }

    .logo-mark {
      width: 72px; height: 72px;
      background: var(--accent);
      border-radius: 20px;
      display: flex; align-items: center; justify-content: center;
      font-size: 36px;
      margin-bottom: 24px;
      box-shadow: 0 0 40px rgba(232,255,71,0.3);
      animation: pulse-logo 3s ease-in-out infinite;
    }
    @keyframes pulse-logo {
      0%,100% { box-shadow: 0 0 40px rgba(232,255,71,0.3); }
      50%      { box-shadow: 0 0 60px rgba(232,255,71,0.5); }
    }

    .home-title {
      font-family: 'Syne', sans-serif;
      font-size: 48px; font-weight: 800;
      letter-spacing: -2px;
      line-height: 1;
      color: var(--text);
      margin-bottom: 8px;
    }

    .home-sub {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 48px;
    }

    .daily-card {
      width: 100%;
      max-width: 360px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 20px;
      margin-bottom: 28px;
    }

    .daily-label {
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .daily-date {
      font-family: 'Syne', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 16px;
    }

    .daily-progress {
      display: flex; gap: 6px;
    }
    .progress-pip {
      flex: 1; height: 4px;
      background: var(--surface2);
      border-radius: 2px;
      transition: background 0.3s;
    }
    .progress-pip.done { background: var(--accent); }

    .btn-primary {
      width: 100%; max-width: 360px;
      height: 56px;
      background: var(--accent);
      color: #0a0a0f;
      font-family: 'Syne', sans-serif;
      font-size: 16px; font-weight: 700;
      letter-spacing: 0.02em;
      border: none; border-radius: 14px;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .btn-primary:active {
      transform: scale(0.97);
      box-shadow: 0 0 0 4px rgba(232,255,71,0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 28px;
      cursor: pointer;
      margin-top: 14px;
      width: 100%; max-width: 360px;
      transition: color 0.2s, border-color 0.2s;
    }
    .btn-ghost:active { color: var(--text); border-color: rgba(255,255,255,0.2); }

    .streak-row {
      display: flex; gap: 20px;
      margin-top: 28px;
    }
    .streak-item {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
    }
    .streak-num {
      font-family: 'Syne', sans-serif;
      font-size: 28px; font-weight: 800;
      color: var(--accent);
    }
    .streak-lbl {
      font-size: 10px; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--muted);
    }

    /* â”€â”€â”€ GAME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #game { padding: 0; background: var(--bg); }

    #map {
      position: absolute; inset: 0;
      background: #111;
    }

    /* Top HUD */
    .hud {
      position: absolute;
      top: calc(var(--safe-top) + 12px);
      left: 12px; right: 12px;
      display: flex; align-items: center; gap: 10px;
      z-index: 10;
    }
    .hud-card {
      background: rgba(10,10,15,0.85);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 14px;
    }
    .hud-round {
      font-family: 'Syne', sans-serif;
      font-size: 13px; font-weight: 700;
      color: var(--text);
    }
    .hud-round span { color: var(--accent); }
    .hud-score-wrap { flex: 1; }
    .hud-score-label {
      font-size: 9px; letter-spacing: 0.15em;
      text-transform: uppercase; color: var(--muted);
    }
    .hud-score {
      font-family: 'Syne', sans-serif;
      font-size: 20px; font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }
    .hud-dots {
      display: flex; gap: 5px; align-items: center;
    }
    .hud-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--surface2);
      transition: background 0.3s;
    }
    .hud-dot.done { background: var(--accent); }
    .hud-dot.current {
      background: transparent;
      border: 2px solid var(--accent);
      animation: dot-pulse 1.2s ease-in-out infinite;
    }
    @keyframes dot-pulse {
      0%,100% { transform: scale(1); }
      50%      { transform: scale(1.3); }
    }

    /* Clue banner */
    .clue-banner {
      position: absolute;
      bottom: calc(var(--safe-bot) + 148px);
      left: 12px; right: 12px;
      background: rgba(10,10,15,0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 18px;
      z-index: 10;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .clue-label {
      font-size: 9px; letter-spacing: 0.15em;
      text-transform: uppercase; color: var(--accent);
      margin-bottom: 4px;
    }
    .clue-text {
      font-family: 'Syne', sans-serif;
      font-size: 15px; font-weight: 600;
      color: var(--text);
      line-height: 1.4;
    }

    /* Bottom action bar */
    .action-bar {
      position: absolute;
      bottom: var(--safe-bot);
      left: 0; right: 0;
      padding: 12px 16px 16px;
      background: linear-gradient(to top, rgba(10,10,15,0.98) 60%, transparent);
      z-index: 10;
      display: flex; flex-direction: column; gap: 10px;
    }

    /* Pin confirmation UI */
    .pin-confirm {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      display: flex; align-items: center; gap: 12px;
      opacity: 0; transform: translateY(8px);
      transition: opacity 0.25s, transform 0.25s;
      pointer-events: none;
    }
    .pin-confirm.visible {
      opacity: 1; transform: translateY(0); pointer-events: auto;
    }
    .pin-confirm-coords {
      flex: 1;
    }
    .pin-confirm-label {
      font-size: 9px; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--muted);
    }
    .pin-confirm-val {
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 700;
      color: var(--text);
    }
    .btn-lock {
      height: 44px; padding: 0 20px;
      background: var(--accent);
      color: #0a0a0f;
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 700;
      border: none; border-radius: 10px;
      cursor: pointer;
      transition: transform 0.15s;
      white-space: nowrap;
    }
    .btn-lock:active { transform: scale(0.95); }
    .btn-cancel-pin {
      height: 44px; padding: 0 14px;
      background: var(--surface2);
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      border: none; border-radius: 10px;
      cursor: pointer;
    }

    .tap-hint {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.05em;
      padding-bottom: 4px;
      transition: opacity 0.3s;
    }
    .tap-hint.hidden-hint { opacity: 0; }

    /* â”€â”€â”€ RESULT OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .result-overlay {
      position: absolute;
      inset: 0; z-index: 20;
      background: rgba(10,10,15,0.7);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: flex; align-items: flex-end;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .result-overlay.visible { opacity: 1; pointer-events: auto; }

    .result-sheet {
      width: 100%;
      background: var(--surface);
      border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      padding: 20px 24px calc(var(--safe-bot) + 20px);
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .result-overlay.visible .result-sheet {
      transform: translateY(0);
    }

    .result-handle {
      width: 40px; height: 4px;
      background: var(--surface2);
      border-radius: 2px;
      margin: 0 auto 20px;
    }

    .result-round-label {
      font-size: 10px; letter-spacing: 0.15em;
      text-transform: uppercase; color: var(--muted);
      text-align: center; margin-bottom: 6px;
    }
    .result-location {
      font-family: 'Syne', sans-serif;
      font-size: 22px; font-weight: 800;
      text-align: center; color: var(--text);
      margin-bottom: 20px;
    }

    .result-stats {
      display: flex; gap: 0;
      background: var(--bg);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    .result-stat {
      flex: 1;
      padding: 14px 8px;
      text-align: center;
      border-right: 1px solid var(--border);
    }
    .result-stat:last-child { border-right: none; }
    .result-stat-val {
      font-family: 'Syne', sans-serif;
      font-size: 22px; font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }
    .result-stat-lbl {
      font-size: 9px; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--muted);
      margin-top: 4px;
    }

    /* Score bar */
    .score-bar-wrap {
      margin-bottom: 20px;
    }
    .score-bar-track {
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .score-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      border-radius: 4px;
      transition: width 0.8s cubic-bezier(0.34, 1.2, 0.64, 1);
      width: 0%;
    }
    .score-bar-labels {
      display: flex; justify-content: space-between;
      margin-top: 6px;
    }
    .score-bar-lbl {
      font-size: 10px; color: var(--muted);
    }
    .score-bar-lbl.right {
      font-family: 'Syne', sans-serif;
      font-size: 12px; font-weight: 700;
      color: var(--accent);
    }

    .btn-next {
      width: 100%; height: 52px;
      background: var(--accent);
      color: #0a0a0f;
      font-family: 'Syne', sans-serif;
      font-size: 16px; font-weight: 700;
      border: none; border-radius: 14px;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .btn-next:active { transform: scale(0.97); }

    /* â”€â”€â”€ SUMMARY SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #summary {
      background: var(--bg);
      overflow-y: auto;
    }
    .summary-bg {
      position: absolute; inset: 0;
      background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(232,255,71,0.07) 0%, transparent 60%);
      pointer-events: none;
    }
    .summary-inner {
      position: relative; z-index: 1;
      width: 100%; max-width: 400px;
      padding: 32px 24px calc(var(--safe-bot) + 24px);
    }

    .summary-logo {
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 800;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .summary-title {
      font-family: 'Syne', sans-serif;
      font-size: 36px; font-weight: 800;
      letter-spacing: -1px;
      margin-bottom: 4px;
    }
    .summary-date {
      font-size: 12px; color: var(--muted);
      margin-bottom: 28px;
    }

    .final-score-ring {
      width: 140px; height: 140px;
      border-radius: 50%;
      background: conic-gradient(var(--accent) 0%, var(--accent2) 60%, var(--surface2) 60%);
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 28px;
      position: relative;
    }
    .final-score-ring::after {
      content: '';
      position: absolute;
      inset: 8px;
      background: var(--bg);
      border-radius: 50%;
    }
    .final-score-inner {
      position: relative; z-index: 1; text-align: center;
    }
    .final-score-num {
      font-family: 'Syne', sans-serif;
      font-size: 32px; font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }
    .final-score-max {
      font-size: 11px; color: var(--muted);
    }

    .round-breakdown {
      width: 100%;
      display: flex; flex-direction: column; gap: 8px;
      margin-bottom: 24px;
    }
    .round-row {
      display: flex; align-items: center; gap: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
    }
    .round-row-num {
      width: 24px; height: 24px;
      border-radius: 50%;
      background: var(--surface2);
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700;
      color: var(--muted);
      flex-shrink: 0;
    }
    .round-row-name {
      flex: 1;
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 600;
      color: var(--text);
    }
    .round-row-dist {
      font-size: 11px; color: var(--muted);
    }
    .round-row-score {
      font-family: 'Syne', sans-serif;
      font-size: 15px; font-weight: 700;
    }

    /* Emoji share card */
    .share-card {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      font-family: 'DM Mono', monospace;
    }
    .share-card-header {
      font-size: 11px; color: var(--muted);
      margin-bottom: 8px;
    }
    .share-card-emoji {
      font-size: 22px;
      letter-spacing: 2px;
      line-height: 1.6;
    }
    .share-card-footer {
      margin-top: 8px;
      font-size: 11px; color: var(--muted);
    }

    .btn-share {
      width: 100%; height: 52px;
      background: var(--accent);
      color: #0a0a0f;
      font-family: 'Syne', sans-serif;
      font-size: 16px; font-weight: 700;
      border: none; border-radius: 14px;
      cursor: pointer;
      margin-bottom: 10px;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: transform 0.15s;
    }
    .btn-share:active { transform: scale(0.97); }

    .btn-home {
      width: 100%; height: 48px;
      background: transparent;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: 14px;
      cursor: pointer;
    }

    /* â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      top: calc(var(--safe-top) + 20px);
      left: 50%; transform: translateX(-50%) translateY(-70px);
      background: var(--text);
      color: var(--bg);
      font-family: 'Syne', sans-serif;
      font-size: 13px; font-weight: 700;
      padding: 10px 20px;
      border-radius: 100px;
      white-space: nowrap;
      z-index: 100;
      transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: none;
    }
    #toast.show { transform: translateX(-50%) translateY(0); }


    /* â”€â”€â”€ REVIEW SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #review { padding: 0; background: var(--bg); }

    #review-map {
      position: absolute; inset: 0;
      background: #111;
    }

    .review-panel {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: linear-gradient(to top, rgba(10,10,15,1) 0%, rgba(10,10,15,0.97) 70%, transparent 100%);
      padding: 24px 16px calc(var(--safe-bot) + 16px);
      z-index: 10;
    }

    .review-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 14px;
    }
    .review-title-block {}
    .review-eyebrow {
      font-size: 9px; letter-spacing: 0.18em; text-transform: uppercase;
      color: var(--accent); margin-bottom: 3px;
    }
    .review-title {
      font-family: 'Syne', sans-serif;
      font-size: 20px; font-weight: 800;
      color: var(--text); line-height: 1;
    }
    .review-score-badge {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 16px;
      text-align: center;
    }
    .review-score-num {
      font-family: 'Syne', sans-serif;
      font-size: 22px; font-weight: 800;
      color: var(--accent); line-height: 1;
    }
    .review-score-denom {
      font-size: 10px; color: var(--muted);
    }

    .review-legend {
      display: flex; gap: 16px;
      margin-bottom: 14px;
    }
    .review-legend-item {
      display: flex; align-items: center; gap: 6px;
      font-size: 11px; color: var(--muted);
    }
    .legend-dot {
      width: 10px; height: 10px; border-radius: 50%;
      flex-shrink: 0;
    }
    .legend-dot.user   { background: #e8ff47; }
    .legend-dot.answer { background: #47c8ff; }

    .review-rounds {
      display: flex; gap: 6px;
      margin-bottom: 14px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 2px;
    }
    .review-rounds::-webkit-scrollbar { display: none; }

    .review-round-chip {
      flex-shrink: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      text-align: center;
      min-width: 70px;
    }
    .review-round-chip.active {
      border-color: var(--accent);
      background: rgba(232,255,71,0.08);
    }
    .review-chip-name {
      font-size: 10px; color: var(--muted);
      white-space: nowrap; overflow: hidden;
      text-overflow: ellipsis; max-width: 80px;
      margin-bottom: 3px;
    }
    .review-chip-score {
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 700;
      color: var(--text);
    }

    .btn-share-review {
      width: 100%; height: 52px;
      background: var(--accent);
      color: #0a0a0f;
      font-family: 'Syne', sans-serif;
      font-size: 16px; font-weight: 700;
      border: none; border-radius: 14px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: transform 0.15s;
      margin-bottom: 10px;
    }
    .btn-share-review:active { transform: scale(0.97); }

    .btn-back-home {
      width: 100%; height: 44px;
      background: transparent;
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
    }

    /* Home screen played state */
    .home-played-banner {
      width: 100%; max-width: 360px;
      background: rgba(232,255,71,0.07);
      border: 1px solid rgba(232,255,71,0.2);
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 12px;
      display: flex; align-items: center; gap: 12px;
    }
    .home-played-icon { font-size: 24px; }
    .home-played-text {}
    .home-played-label {
      font-size: 10px; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--accent);
      margin-bottom: 2px;
    }
    .home-played-score {
      font-family: 'Syne', sans-serif;
      font-size: 20px; font-weight: 800;
      color: var(--text);
    }

    /* Mapbox overrides */
    .mapboxgl-ctrl-bottom-left, .mapboxgl-ctrl-bottom-right,
    .mapboxgl-ctrl-top-left, .mapboxgl-ctrl-top-right { display: none !important; }
    .mapboxgl-canvas { cursor: crosshair; }
  </style>
</head>
<body>

<!-- â”€â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="home" class="screen">
  <div class="home-bg"></div>
  <div class="home-inner">
    <div class="logo-mark">ğŸ“</div>
    <h1 class="home-title">PinDrop</h1>
    <p class="home-sub">Daily Geography Challenge</p>

    <div class="daily-card">
      <div class="daily-label">Today's Challenge</div>
      <div class="daily-date" id="home-date">â€”</div>
      <div class="daily-progress" id="home-progress">
        <div class="progress-pip"></div>
        <div class="progress-pip"></div>
        <div class="progress-pip"></div>
        <div class="progress-pip"></div>
        <div class="progress-pip"></div>
      </div>
    </div>

    <button class="btn-primary" id="btn-play">Drop Today's Pins â†’</button>
    <button class="btn-ghost" id="btn-how">How to Play</button>

    <div class="streak-row">
      <div class="streak-item">
        <div class="streak-num" id="home-streak">0</div>
        <div class="streak-lbl">Day Streak</div>
      </div>
      <div class="streak-item">
        <div class="streak-num" id="home-best">â€”</div>
        <div class="streak-lbl">Best Score</div>
      </div>
      <div class="streak-item">
        <div class="streak-num" id="home-played">0</div>
        <div class="streak-lbl">Played</div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="game" class="screen hidden">
  <div id="map"></div>

  <!-- HUD -->
  <div class="hud">
    <div class="hud-card">
      <div class="hud-round">Round <span id="hud-round-num">1</span>/5</div>
    </div>
    <div class="hud-card hud-score-wrap">
      <div class="hud-score-label">Score</div>
      <div class="hud-score" id="hud-score">0</div>
    </div>
    <div class="hud-card hud-dots" id="hud-dots"></div>
  </div>

  <!-- Clue -->
  <div class="clue-banner">
    <div class="clue-label">Find this location</div>
    <div class="clue-text" id="clue-text">Loadingâ€¦</div>
  </div>

  <!-- Action bar -->
  <div class="action-bar">
    <div class="pin-confirm" id="pin-confirm">
      <div class="pin-confirm-coords">
        <div class="pin-confirm-label">Your Pin</div>
        <div class="pin-confirm-val" id="pin-coords">â€”</div>
      </div>
      <button class="btn-cancel-pin" id="btn-cancel-pin">âœ•</button>
      <button class="btn-lock" id="btn-lock">Lock It In âœ“</button>
    </div>
    <div class="tap-hint" id="tap-hint">Tap the map to drop your pin</div>
  </div>

  <!-- Round result overlay -->
  <div class="result-overlay" id="result-overlay">
    <div class="result-sheet">
      <div class="result-handle"></div>
      <div class="result-round-label" id="result-round-label">Round 1 of 5</div>
      <div class="result-location" id="result-location">â€”</div>
      <div class="result-quality" id="result-quality" style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;margin:-4px 0 12px;"></div>

      <div class="result-stats">
        <div class="result-stat">
          <div class="result-stat-val" id="result-dist">â€”</div>
          <div class="result-stat-lbl">Away</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-val" id="result-pts">â€”</div>
          <div class="result-stat-lbl">Points</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-val" id="result-total">â€”</div>
          <div class="result-stat-lbl">Total</div>
        </div>
      </div>

      <div class="score-bar-wrap">
        <div class="score-bar-track">
          <div class="score-bar-fill" id="score-bar-fill"></div>
        </div>
        <div class="score-bar-labels">
          <span class="score-bar-lbl">0</span>
          <span class="score-bar-lbl right" id="score-bar-pct">â€”</span>
          <span class="score-bar-lbl">200</span>
        </div>
      </div>

      <div id="result-description" style="
        font-size: 13px;
        line-height: 1.55;
        color: rgba(240,240,245,0.55);
        font-family: 'DM Mono', monospace;
        font-weight: 300;
        margin: -8px 0 18px;
        padding: 10px 14px;
        background: rgba(255,255,255,0.04);
        border-radius: 10px;
        border-left: 2px solid rgba(255,255,255,0.12);
        text-align: left;
      "></div>

      <button class="btn-next" id="btn-next">Next Round â†’</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="summary" class="screen hidden">
  <div class="summary-bg"></div>
  <div class="summary-inner">
    <div class="summary-logo">PinDrop</div>
    <h2 class="summary-title">Daily<br/>Complete.</h2>
    <div class="summary-date" id="summary-date">â€”</div>

    <div class="final-score-ring" id="score-ring">
      <div class="final-score-inner">
        <div class="final-score-num" id="final-score">0</div>
        <div class="final-score-max">/ 1000</div>
      </div>
    </div>

    <div class="round-breakdown" id="round-breakdown"></div>

    <div class="share-card">
      <div class="share-card-header">ğŸ“ PinDrop Â· <span id="share-day">Day #1</span></div>
      <div class="share-card-emoji" id="share-emojis"></div>
      <div class="share-card-footer" id="share-score-line"></div>
    </div>

    <button class="btn-share" id="btn-share">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
      </svg>
      Share My Score
    </button>
    <button class="btn-home" id="btn-home-from-summary">â† Back to Home</button>
  </div>
</div>


<!-- â”€â”€â”€ REVIEW (already played) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="review" class="screen hidden">
  <div id="review-map"></div>

  <div class="review-panel">
    <div class="review-header">
      <div class="review-title-block">
        <div class="review-eyebrow">Today's Results</div>
        <div class="review-title" id="review-title">â€”</div>
      </div>
      <div class="review-score-badge">
        <div class="review-score-num" id="review-score-num">â€”</div>
        <div class="review-score-denom">/ 1000</div>
      </div>
    </div>

    <div class="review-legend">
      <div class="review-legend-item">
        <div class="legend-dot user"></div>
        <span>Your guess</span>
      </div>
      <div class="review-legend-item">
        <div class="legend-dot answer"></div>
        <span>Actual location</span>
      </div>
    </div>

    <div class="review-rounds" id="review-rounds"></div>

    <button class="btn-share-review" id="btn-share-review">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
      </svg>
      Challenge Your Friends
    </button>
    <button class="btn-back-home" id="btn-back-home-review">â† Back to Home</button>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIGURATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// âš ï¸  REPLACE WITH YOUR MAPBOX TOKEN
const MAPBOX_TOKEN = '__MAPBOX_TOKEN__';

// Location database - seeded daily
// Each entry: [name, clue, lat, lng, perfectRadiusKm?]
// perfectRadiusKm: anything within this distance = full 200pts. Default 5km (cities/monuments).
// Use larger values for sprawling geographic features (lakes, deserts, national parks, etc.)
const LOCATIONS = [
  // â”€â”€ EUROPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Eiffel Tower, Paris",          "Europe's most-photographed iron lattice tower, built in 1889",                   48.8584,   2.2945],
  ["Colosseum, Rome",              "Ancient amphitheater that once held 80,000 spectators",                          41.8902,  12.4922],
  ["Sagrada FamÃ­lia, Barcelona",   "GaudÃ­'s unfinished basilica, under construction since 1882",                     41.4036,   2.1744],
  ["Acropolis, Athens",            "Ancient citadel containing the Parthenon, overlooking Athens",                   37.9715,  23.7267],
  ["Stonehenge, England",          "Prehistoric ring of standing stones on Salisbury Plain",                         51.1789,  -1.8262],
  ["Big Ben, London",              "Iconic clock tower at the north end of the Houses of Parliament",                51.5007,  -0.1246],
  ["Hagia Sophia, Istanbul",       "6th-century cathedral turned mosque, a symbol of two great empires",             41.0086,  28.9802],
  ["Neuschwanstein Castle",        "Fairy-tale Bavarian castle that inspired Disney's Sleeping Beauty",              47.5576,  10.7498],
  ["Santorini Caldera, Greece",    "Volcanic island famous for blue-domed churches and sunsets",                     36.3932,  25.4615,  12],
  ["Alhambra Palace, Granada",     "Stunning Moorish palace and fortress complex in southern Spain",                 37.1760,  -3.5881],
  ["Mont Saint-Michel, France",    "Tidal island commune topped by a medieval abbey off the Normandy coast",         48.6360,  -1.5114],
  ["Dubrovnik Old City, Croatia",  "Walled medieval city on the Adriatic coast, known as the Pearl of the Adriatic", 42.6507,  18.0944],
  ["Colmar, France",               "Picturesque Alsatian town of half-timbered houses on canals",                    48.0793,   7.3585],
  ["Hallstatt, Austria",           "Tiny lakeside village in the Austrian Alps, one of Europe's oldest towns",       47.5622,  13.6493],
  ["Cinque Terre, Italy",          "Five colorful clifftop fishing villages strung along the Ligurian coast",        44.1461,   9.6439,  10],
  ["Plitvice Lakes, Croatia",      "Cascading turquoise lakes and waterfalls in a UNESCO national park",             44.8654,  15.5820,  10],
  ["Meteora, Greece",              "Byzantine monasteries perched atop soaring sandstone rock pillars",              39.7217,  21.6306],
  ["Bruges, Belgium",              "Impeccably preserved medieval city crisscrossed by canals",                      51.2093,   3.2247],
  ["Ronda, Spain",                 "Dramatic clifftop city split by a 120-meter gorge in Andalusia",                 36.7464,  -5.1613],
  ["Amalfi Coast, Italy",          "Dramatic stretch of coastline with clifftop villages above the Tyrrhenian Sea",  40.6340,  14.6027,  15],
  ["Vatican City",                 "World's smallest country, home to St. Peter's Basilica and the Sistine Chapel", 41.9029,  12.4534],
  ["Charles Bridge, Prague",       "14th-century Gothic bridge lined with Baroque statues over the Vltava River",   50.0865,  14.4114],
  ["Loch Ness, Scotland",          "Deep glacial loch in the Scottish Highlands, famously home to a mythical beast", 57.3229,  -4.4244,  18],
  ["Cappadocia, Turkey",           "Surreal landscape of fairy chimneys and cave dwellings in central Anatolia",    38.6431,  34.8289,  20],
  ["Trolltunga, Norway",           "Dramatic rock ledge jutting horizontally above a fjord in western Norway",       60.1241,   6.7398],
  ["Fiordland, New Zealand",       "Remote fjordland of dramatic peaks, waterfalls and dark waters",                -45.4169, 167.7180],
  ["Pamukkale, Turkey",            "Natural terraces of mineral-rich thermal waters cascading down white travertine", 37.9199,  29.1202],
  ["Sintra, Portugal",             "Fairy-tale hilltop town of colorful palaces hidden in forested mountains",       38.7978,  -9.3876],
  ["Cliffs of Moher, Ireland",     "Dramatic sea cliffs rising 214m above the Atlantic on Ireland's west coast",    52.9715,  -9.4309,  10],
  ["Lake Bled, Slovenia",          "Alpine lake with an island church and medieval castle on a cliff above",         46.3683,  14.0938],

  // â”€â”€ ASIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Mount Fuji, Japan",            "Japan's highest peak, a near-perfect volcanic cone visible from Tokyo",          35.3606, 138.7274],
  ["Taj Mahal, Agra",              "Ivory-white marble mausoleum on the south bank of the Yamuna River",            27.1751,  78.0421],
  ["Angkor Wat, Cambodia",         "World's largest religious monument, ancient Khmer capital",                      13.4125, 103.8670],
  ["Great Wall of China",          "Fortification spanning thousands of miles across northern China",                40.4319, 116.5704],
  ["Halong Bay, Vietnam",          "Emerald waters studded with thousands of limestone karst islands",               20.9101, 107.1839,  20],
  ["Bagan, Myanmar",               "Ancient plain scattered with thousands of Buddhist temples and pagodas",         21.1717,  94.8585,  12],
  ["Petra, Jordan",                "Rose-red city half as old as time, carved into sandstone cliffs",               30.3285,  35.4444],
  ["Burj Khalifa, Dubai",          "World's tallest building at 828 meters in the UAE",                             25.1972,  55.2744],
  ["Borobudur, Indonesia",         "9th-century Mahayana Buddhist temple, the world's largest",                     -7.6079, 110.2038],
  ["Sigiriya, Sri Lanka",          "Ancient rock fortress rising 180m above the jungle with frescoed walls",          7.9570,  80.7603],
  ["Shwedagon Pagoda, Myanmar",    "98-meter gilded Buddhist stupa dominating the Yangon skyline",                  16.7986,  96.1497],
  ["Jiuzhaigou Valley, China",     "Remote valley of multi-colored lakes and waterfalls in Sichuan province",        33.2600, 103.9200,  12],
  ["Zhangjiajie, China",           "Towering sandstone pillar mountains that inspired Avatar's floating peaks",      29.1260, 110.4790,  15],
  ["Kyoto Bamboo Grove, Japan",    "Dense forest of towering bamboo stalks in the Arashiyama district",             35.0117, 135.6761],
  ["Uluru, Australia",             "Sacred sandstone monolith rising from Australia's Red Centre",                  -25.3444, 131.0369],
  ["Dead Sea, Jordan",             "Earth's lowest point and saltiest body of water, where you float effortlessly",  31.5590,  35.4732,  20],
  ["Wadi Rum, Jordan",             "Vast desert landscape of rose-red sandstone mountains and valleys",              29.5797,  35.4229,  20],
  ["Maldives Atolls",              "Low-lying coral atolls scattered across the Indian Ocean",                        4.1755,  73.5093,  75],
  ["Phi Phi Islands, Thailand",    "Dramatic limestone cliffs rising from turquoise Andaman Sea waters",              7.7407,  98.7784,  12],
  ["Guilin Karst, China",          "Surreal landscape of limestone peaks rising from rice paddies and rivers",       24.8138, 110.4980,  15],

  // â”€â”€ AFRICA & MIDDLE EAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Great Pyramid of Giza",        "Last surviving wonder of the ancient world, built for Pharaoh Khufu",            29.9792,  31.1342],
  ["Victoria Falls, Zambia",       "World's largest waterfall by combined width and height",                         -17.9244,  25.8567],
  ["Mount Kilimanjaro, Tanzania",  "Africa's highest peak, a freestanding volcanic mountain capped in snow",          -3.0674,  37.3556],
  ["Serengeti, Tanzania",          "Vast savanna ecosystem famous for the annual wildebeest migration",               -2.3333,  34.8333,  50],
  ["Sossusvlei, Namibia",          "Towering red sand dunes surrounding a stark white clay pan in the Namib Desert", -24.7272,  15.3445,  20],
  ["Sahara Desert, Algeria",       "World's largest hot desert, stretching across North Africa",                     23.4162,   5.0418,  75],
  ["Okavango Delta, Botswana",     "World's largest inland delta, a lush oasis in the middle of the Kalahari",       -19.2948,  22.9411,  40],
  ["Wadi Halfa, Sudan",            "Ancient town on the banks of the Nile near the Egyptian border",                 21.8006,  31.3503],
  ["Mount Nyiragongo, DRC",        "Active stratovolcano with the world's largest lava lake in its crater",           -1.5216,  29.2497],
  ["Lamu Old Town, Kenya",         "Swahili stone town and the oldest living settlement in East Africa",             -2.2696,  40.9020],
  ["Djemaa el-Fna, Marrakech",     "Legendary square and marketplace at the heart of Marrakech's medina",           31.6258,  -7.9892],
  ["Timbuktu, Mali",               "Fabled Saharan city, once the world's most important center of Islamic learning", 16.7735,  -3.0074],
  ["Danakil Depression, Ethiopia", "One of the hottest and most alien landscapes on Earth, with lava lakes and salt flats", 14.2417, 40.3100,  35],

  // â”€â”€ AMERICAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Machu Picchu, Peru",           "Lost Inca citadel high in the Andes, rediscovered in 1911",                     -13.1631, -72.5450],
  ["Grand Canyon, USA",            "Mile-deep gorge carved by the Colorado River over millions of years",            36.1069,-112.1129,  25],
  ["Iguazu Falls, Argentina",      "Spectacular waterfall system on the Argentine-Brazilian border",                 -25.6953, -54.4367],
  ["ChichÃ©n ItzÃ¡, Mexico",         "Mayan pyramid dedicated to Kukulcan, built circa 600 AD",                       20.6843, -88.5678],
  ["Statue of Liberty, New York",  "French gift to the US standing in New York Harbor since 1886",                  40.6892, -74.0445],
  ["Golden Gate Bridge",           "Iconic suspension bridge spanning the entrance to San Francisco Bay",            37.8199,-122.4783],
  ["Christ the Redeemer, Rio",     "Art Deco statue of Jesus atop Corcovado mountain overlooking Rio",              -22.9519, -43.2105],
  ["GalÃ¡pagos Islands, Ecuador",   "Pacific archipelago that inspired Darwin's theory of evolution",                  -0.9538, -90.9656,  60],
  ["Antelope Canyon, USA",         "Narrow slot canyon carved by flash floods in the Arizona sandstone",             36.8619,-111.3743],
  ["Yellowstone, USA",             "World's first national park, sitting atop a supervolcano",                      44.4280,-110.5885,  35],
  ["Patagonia, Argentina",         "Remote wilderness of jagged peaks, glaciers and vast steppe at the end of the world", -50.9423, -73.4068,  75],
  ["Amazon River Delta, Brazil",   "Where the world's largest river meets the Atlantic in a vast maze of channels",   0.1500, -50.0000,  60],
  ["Tikal, Guatemala",             "Ancient Mayan city rising above the jungle canopy, abandoned for a thousand years", 17.2220, -89.6237],
  ["Salar de Uyuni, Bolivia",      "World's largest salt flat, a mirror-like expanse at 3,600m altitude",           -20.1338, -67.4891,  40],
  ["Easter Island, Chile",         "Remote Pacific island famous for its 900 monolithic Moai statues",              -27.1127,-109.3497],
  ["Niagara Falls, Canada",        "Twin waterfalls on the US-Canada border drawing millions of visitors yearly",    43.0896, -79.0849],
  ["Monument Valley, USA",         "Iconic sandstone buttes rising from the Colorado Plateau on Navajo land",        36.9980,-110.0985,  15],
  ["Torres del Paine, Chile",      "Dramatic granite towers soaring above glaciers and turquoise lakes in Patagonia",-50.9423, -72.9956,  20],
  ["Havana Old City, Cuba",        "Colorful colonial architecture and vintage cars in Cuba's historic capital",      23.1360, -82.3590],
  ["Cartagena, Colombia",          "Walled colonial city on the Caribbean coast with brightly painted buildings",    10.3910, -75.4794],

  // â”€â”€ OCEANIA & POLAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Sydney Opera House",           "Sail-shaped performing arts center on Sydney Harbour",                           -33.8568, 151.2153],
  ["Great Barrier Reef, Australia","World's largest coral reef system, visible from space",                          -18.2871, 147.6992,  75],
  ["Milford Sound, New Zealand",   "Fiord of sheer cliffs, waterfalls and wildlife in Fiordland National Park",     -44.6414, 167.8974],
  ["Waitomo Glowworm Caves, NZ",   "Limestone caves illuminated by thousands of bioluminescent glowworms",          -38.2608, 175.1038],
  ["Bora Bora, French Polynesia",  "Volcanic island ringed by turquoise lagoon and overwater bungalows",            -16.5004,-151.7415],
  ["Antarcic Peninsula",           "Icy wilderness of glaciers, penguins and icebergs at the bottom of the world",  -63.4000, -57.0000,  75],
  ["Rotorua, New Zealand",         "Geothermal city of bubbling mud pools, geysers and MÄori culture",             -38.1368, 176.2497],
  ["Kakadu, Australia",            "Ancient Aboriginal land of rock art, wetlands and dramatic escarpments",         -12.6767, 132.8851,  40],
  ["Palau, Micronesia",            "Remote Pacific archipelago of pristine reefs and jellyfish lakes",                7.5150, 134.5825,  25],

  // â”€â”€ MORE EUROPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Svalbard, Norway",             "Arctic archipelago halfway between Norway and the North Pole, land of polar bears",  78.2232,  15.6267,  40],
  ["Pompeii, Italy",               "Roman city frozen in time by the eruption of Vesuvius in 79 AD",                    40.7462,  14.4989],
  ["Dolomites, Italy",             "Jagged pale limestone peaks forming one of the world's most dramatic mountain ranges", 46.4102,  11.8440,  25],
  ["Whitby, England",              "Clifftop ruined abbey and fishing town that inspired Bram Stoker's Dracula",          54.4858,  -0.6206],
  ["GorÃ«me, Turkey",               "Village in the heart of Cappadocia surrounded by cone-shaped fairy chimneys",        38.6431,  34.8289],
  ["Faroe Islands",                "Remote North Atlantic archipelago of dramatic cliffs, puffins and waterfalls",        62.0000,  -6.7900,  25],
  ["Bioluminescent Bay, Menorca",  "Magical sea cave where the water glows electric blue at night",                      39.9063,   4.0600],
  ["Delphi, Greece",               "Ancient sanctuary of Apollo perched on the slopes of Mount Parnassus",               38.4824,  22.5010],
  ["Lake Como, Italy",             "Elegant glacial lake ringed by villas and the foothills of the Alps",                46.0160,   9.2570,  15],
  ["Kirkjufell, Iceland",          "Arrow-shaped mountain beside a waterfall, Iceland's most photographed peak",         64.9280, -23.3070],
  ["SkÃ³gafoss, Iceland",           "Massive curtain waterfall on Iceland's south coast where rainbows appear daily",     63.5322, -19.5133],
  ["Blue Lagoon, Iceland",         "Geothermal spa of milky blue water in a lava field on the Reykjanes Peninsula",     63.8804, -22.4495],
  ["Lavaux Vineyards, Switzerland","UNESCO terraced vineyards cascading down to Lake Geneva beneath the Alps",           46.4900,   6.7600],
  ["Rila Monastery, Bulgaria",     "Striking medieval monastery hidden in a forested mountain valley",                   42.1337,  23.3407],
  ["Bran Castle, Romania",         "Hilltop medieval fortress associated with the legend of Dracula in Transylvania",    45.5152,  25.3673],
  ["Mostar Bridge, Bosnia",        "Elegant 16th-century Ottoman stone bridge spanning the Neretva River",               43.3363,  17.8157],
  ["Kotor, Montenegro",            "Walled medieval town tucked into a dramatic bay on the Adriatic",                   42.4247,  18.7712],
  ["Piazza San Marco, Venice",     "Grand Byzantine basilica and campanile at the ceremonial heart of Venice",           45.4341,  12.3388],
  ["GdaÅ„sk, Poland",               "Hanseatic port city of colorful guild houses on the Baltic Sea",                    54.3520,  18.6466],
  ["ÄŒeskÃ½ Krumlov, Czechia",       "Perfectly preserved medieval town wrapped in a bend of the Vltava River",           48.8127,  14.3175],

  // â”€â”€ MORE ASIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Varanasi Ghats, India",        "Ancient city on the Ganges, the world's holiest Hindu site",                        25.3176,  83.0062],
  ["Hampi, India",                 "Ruins of the mighty Vijayanagara Empire scattered across a boulder-strewn landscape", 15.3350,  76.4600],
  ["Ellora Caves, India",          "Rock-cut cave temples representing Buddhism, Hinduism and Jainism",                  20.0269,  75.1780],
  ["Ha Giang Loop, Vietnam",       "Breathtaking mountain passes and rice terraces in Vietnam's far north",              23.2080, 104.9800,  20],
  ["Batu Caves, Malaysia",         "Limestone hill with a series of caves and cave temples near Kuala Lumpur",            3.2379, 101.6840],
  ["Preah Vihear, Cambodia",       "Stunning Khmer temple perched on a cliff at the edge of the Dangrek escarpment",    14.3914, 104.6786],
  ["Kinkaku-ji, Kyoto",            "Golden Pavilion Zen temple reflected in a still pond, Japan's most visited site",   35.0394, 135.7292],
  ["Miyajima Island, Japan",       "Sacred island where a torii gate appears to float on the sea at high tide",         34.2957, 132.3192],
  ["Hitachi Seaside Park, Japan",  "Fields of nemophila flowers turning hillsides vivid blue every spring",              36.4031, 140.6060],
  ["Zhangye Danxia, China",        "Layered mineral deposits creating a rainbow of striped rock formations",             38.9300, 100.9200,  12],
  ["Hsipaw, Myanmar",              "Quiet Shan town surrounded by tea plantations and tribal villages",                  22.6200,  97.3000],
  ["Nubra Valley, India",          "High-altitude cold desert valley with sand dunes between Himalayan ranges",          34.6500,  77.5500,  20],
  ["Tian Shan, Kazakhstan",        "Vast snowy mountain range stretching across Central Asia",                           42.0000,  78.0000,  75],
  ["Samarkand, Uzbekistan",        "Silk Road city of turquoise-domed mosques and madrasas in Central Asia",             39.6270,  66.9750],
  ["Paro Taktsang, Bhutan",        "Tiger's Nest monastery clinging to a cliff 900m above the Paro Valley",             27.4914,  89.3634],
  ["Coron Island, Philippines",    "Limestone karst island with crystal-clear lagoons and World War II wrecks",          11.9987, 120.2046],
  ["Chocolate Hills, Philippines", "Over 1,200 perfectly conical hills that turn brown in the dry season",              9.8000, 124.1667],
  ["Mergui Archipelago, Myanmar",  "Remote chain of 800 islands in the Andaman Sea, barely touched by tourism",         12.4000,  98.2000,  50],
  ["Wadi Draa, Morocco",           "Long river valley of palm oases and kasbahs cutting through the Sahara",            29.0000,  -6.5000,  30],
  ["Al-Ula, Saudi Arabia",         "Ancient Nabataean city of monumental rock tombs in a dramatic desert canyon",       26.6167,  37.9167],
  ["Socotra Island, Yemen",        "Remote island with alien-looking dragon blood trees found nowhere else on Earth",   12.4634,  53.8237],

  // â”€â”€ MORE AFRICA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Bwindi Forest, Uganda",        "Impenetrable forest reserve home to nearly half the world's mountain gorillas",      -1.0636,  29.6636,  15],
  ["Tsingy de Bemaraha, Madagascar","Forest of razor-sharp limestone pinnacles, a UNESCO natural wonder",               -18.7500,  44.7500,  20],
  ["Omo Valley, Ethiopia",         "Remote valley where ancient tribal cultures have remained largely unchanged",          5.5000,  36.0000,  30],
  ["Saharan Tuareg Camps, Niger",  "Salt caravans and nomadic Tuareg camps deep in the Sahara",                         16.0000,   8.0000,  75],
  ["Bazaruto Archipelago, Mozambique","Pristine coral islands with dugongs, manta rays and dhow sailboats",             -21.6000,  35.4667,  25],
  ["Simien Mountains, Ethiopia",   "Dramatic highlands plateau with vertical escarpments and gelada baboons",            13.2350,  38.0640,  25],
  ["Rwenzori Mountains, Uganda",   "Glaciated equatorial Mountains of the Moon straddling the DRC-Uganda border",        0.3833,  29.9000,  25],
  ["Fish River Canyon, Namibia",   "Second largest canyon in the world, carved over 500 million years",                 -27.6740,  17.5757,  20],
  ["Zanzibar Stone Town, Tanzania","UNESCO Swahili trading port of labyrinthine alleys, spices and carved doors",       -6.1622,  39.1921],
  ["Ngorongoro Crater, Tanzania",  "Vast volcanic caldera sheltering the world's densest concentration of wildlife",     -3.1667,  35.5833,  15],
  ["Dakar, Senegal",               "Westernmost point of continental Africa on a wind-swept Atlantic peninsula",         14.7167, -17.4677],
  ["Chefchaouen, Morocco",         "The Blue Pearl â€” a mountain town where every wall is painted in shades of blue",    35.1688,  -5.2636],

  // â”€â”€ MORE AMERICAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Bryce Canyon, USA",            "Natural amphitheater of crimson hoodoos and spires in Utah",                        37.5930,-112.1871],
  ["Banff, Canada",                "Turquoise glacial lakes and Rocky Mountain peaks in Canada's oldest national park",  51.4968,-115.9281],
  ["Guanajuato, Mexico",           "Colonial city of colorful houses tumbling down hillsides in central Mexico",         21.0190,-101.2574],
  ["Carnaval, Rio de Janeiro",     "Sambadrome where samba schools parade through in an explosion of color and rhythm", -22.9000, -43.1956],
  ["Atacama Desert, Chile",        "World's driest non-polar desert of salt flats, geysers and alien landscapes",       -23.8634, -69.0742,  60],
  ["Oaxaca, Mexico",               "Colonial city known for Zapotec ruins, mezcal and one of Mexico's richest cuisines", 17.0732, -96.7266],
  ["Corcovado, Costa Rica",        "Incredibly biodiverse national park on the Osa Peninsula, a global hotspot",         8.5417, -83.5920],
  ["Pantanal, Brazil",             "World's largest tropical wetland, the best place on Earth to see jaguars",          -17.0000, -57.0000,  75],
  ["Quebrada de Humahuaca, Argentina","Colourful gorge of multicoloured hills and pre-Columbian ruins in the Andes",   -23.2061, -65.3464,  25],
  ["Tayrona, Colombia",            "Lush national park where the Andes meet white-sand beaches on the Caribbean",       11.3204, -73.9192,  15],
  ["Lake Titicaca, Peru",          "World's highest navigable lake straddling the Peru-Bolivia border",                 -15.8402, -69.3361,  60],
  ["Canaima, Venezuela",           "Tepui plateau landscape where Angel Falls â€” world's highest waterfall â€” plunges",    5.9430, -62.8475,  25],
  ["Choquequirao, Peru",           "Remote Inca citadel perched on a ridge, larger than Machu Picchu and rarely visited", -13.5332, -72.8506],
  ["FlorianÃ³polis, Brazil",        "Island city with 42 beaches and a lively surf culture off Brazil's southern coast", -27.5954, -48.5480],
  ["ChiloÃ© Island, Chile",         "Mythical island of wooden churches, palafito stilt houses and misty forests",       -42.6000, -73.9000,  30],
  ["Dominica",                     "Volcanic island of boiling lakes, rainforest and whale-watching in the Caribbean",   15.4150, -61.3710],
  ["Copper Canyon, Mexico",        "System of canyons deeper and wider than the Grand Canyon in the Sierra Madre",      27.5500,-107.7500,  30],

  // â”€â”€ MORE OCEANIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Whitsunday Islands, Australia","74 tropical islands inside the Great Barrier Reef with pure white silica beaches",  -20.2734, 148.8930,  25],
  ["Karijini, Australia",          "Ancient gorges of striped rock plunging into crystal pools in the Pilbara",         -22.3350, 118.3020,  20],
  ["Vanuatu Volcanoes",            "Pacific island nation where you can hike to the rim of an active lava lake",        -15.3767, 166.9592,  25],
  ["Lord Howe Island, Australia",  "Remote crescent island of coral reefs and 300m basalt sea stacks in the Tasman Sea", -31.5540, 159.0820],
  ["Aoraki/Mt Cook, New Zealand",  "New Zealand's highest peak, rising above a valley of glaciers",                    -43.5950, 170.1418],
  ["Raja Ampat, Indonesia",        "Remote archipelago with the highest marine biodiversity on Earth",                  -0.2333, 130.5167,  40],
  ["Komodo Island, Indonesia",     "Home of the Komodo dragon, the world's largest living lizard",                      -8.5500, 119.4500],
  ["Tonga",                        "Polynesian kingdom of 170 islands where you can swim with humpback whales",        -21.1790,-175.1982,  40],
  ["Samoa",                        "Lush volcanic islands of To Sua ocean trenches and to-the-last-resort beaches",    -13.7590,-172.1046,  30],

  // â”€â”€ UNIQUE & OFFBEAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ["Surtsey, Iceland",             "Volcanic island that erupted from the sea in 1963 â€” one of Earth's newest lands",   63.3000, -20.6000],
  ["Tristan da Cunha",             "The world's most remote inhabited island, 2,800km from the nearest land",          -37.1052, -12.2777],
  ["Oymyakon, Russia",             "The coldest permanently inhabited place on Earth in the Siberian taiga",            63.4608, 142.7858],
  ["Dallol, Ethiopia",             "Hottest year-round inhabited place on Earth, a psychedelic hydrothermal landscape",  14.2417,  40.2983],
  ["Nauru",                        "World's smallest island nation and third-smallest country by area",                  -0.5228, 166.9315],
  ["Hashima Island, Japan",        "Abandoned concrete island fortress that was once the world's most densely populated place", 32.6278, 129.7381],
  ["Chernobyl, Ukraine",           "Exclusion zone around the 1986 nuclear disaster, now a haunting ghost landscape",   51.2731,  30.2219],
  ["Salar de Atacama, Chile",      "Lithium-rich salt flat ringed by volcanoes, home to flamingo colonies",             -23.4935, -68.2500,  30],
  ["Skeleton Coast, Namibia",      "Foggy Atlantic coast of shipwrecks, seal colonies and desert-adapted lions",        -19.0000,  12.5000,  60],
  ["Kamchatka Peninsula, Russia",  "Remote volcanic peninsula of geysers, brown bears and undisturbed wilderness",      54.0000, 159.0000,  60],
  ["Svalbard Global Seed Vault",   "Doomsday vault buried in permafrost preserving the world's crop diversity",         78.2380,  15.4910],
  ["Inaccessible Island",          "Uninhabited volcanic island â€” one of the most remote places on the planet",        -37.3120, -12.6780],
];
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const ROUNDS_PER_GAME = 5;
const MAX_SCORE_PER_ROUND = 200;

let map = null;
let state = {
  round: 0,
  totalScore: 0,
  roundResults: [],
  pendingPin: null,
  pinMarker: null,
  answerMarker: null,
  answerLine: null,
  todayLocations: [],
  gameComplete: false,
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function seededRand(seed) {
  // Simple LCG
  let s = seed;
  return () => {
    s = (s * 1664525 + 1013904223) & 0xffffffff;
    return (s >>> 0) / 0x100000000;
  };
}

function getDailySeed() {
  const d = new Date();
  return d.getFullYear() * 10000 + (d.getMonth() + 1) * 100 + d.getDate();
}

function getDayNumber() {
  const epoch = new Date('2025-01-01');
  const now = new Date();
  return Math.floor((now - epoch) / 86400000) + 1;
}

function getTodayLocations() {
  const rand = seededRand(getDailySeed());
  const indices = [];
  const pool = [...Array(LOCATIONS.length).keys()];
  for (let i = 0; i < ROUNDS_PER_GAME; i++) {
    const idx = Math.floor(rand() * pool.length);
    indices.push(pool.splice(idx, 1)[0]);
  }
  return indices.map(i => LOCATIONS[i]);
}

function haversineKm(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function scoreFromDistance(km, perfectRadius = 5) {
  // Anything within perfectRadius = full marks. Beyond that the normal curve applies.
  const d = Math.max(0, km - perfectRadius);
  if (d <= 0)     return 200;
  if (d <= 25)    return Math.round(200 - (d / 25) * 10);           // 200 â†’ 190
  if (d <= 500)   return Math.round(190 - ((d - 25) / 475) * 110);  // 190 â†’ 80
  if (d <= 2000)  return Math.round(80  - ((d - 500) / 1500) * 60); // 80  â†’ 20
  if (d <= 10000) return Math.round(20  - ((d - 2000) / 8000) * 20);// 20  â†’ 0
  return 0;
}

function formatDist(km) {
  if (km < 1) return `${Math.round(km * 1000)}m`;
  if (km >= 1000) return `${(km/1000).toFixed(1)}k km`;
  return `${Math.round(km)} km`;
}

function scoreToEmoji(pts) {
  if (pts >= 190) return 'ğŸ¯'; // Exact
  if (pts >= 150) return 'ğŸŸ¢'; // Great
  if (pts >= 100) return 'ğŸŸ¡'; // Good
  if (pts >= 50)  return 'ğŸŸ '; // Okay
  if (pts >= 20)  return 'ğŸ”´'; // Bad
  return 'âš«';                  // Way Off
}

function scoreToLabel(pts) {
  if (pts >= 190) return 'Exact!';
  if (pts >= 150) return 'Great';
  if (pts >= 100) return 'Good';
  if (pts >= 50)  return 'Okay';
  if (pts >= 20)  return 'Bad';
  return 'Way Off';
}

function scoreToColor(pts) {
  if (pts >= 190) return '#47ffff';
  if (pts >= 150) return '#47ff9e';
  if (pts >= 100) return '#e8ff47';
  if (pts >= 50)  return '#ffaa47';
  if (pts >= 20)  return '#ff8c47';
  return '#ff5c5c';
}

function showToast(msg, duration = 2000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

function formatDate(d) {
  return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const STORAGE_KEY = 'pindrop_v1';

function loadStorage() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  } catch { return {}; }
}

function saveStorage(data) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch {}
}

function getTodayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}

function updateStats(finalScore) {
  const store = loadStorage();
  const today = getTodayKey();
  store.played = (store.played || 0) + 1;
  store.bestScore = Math.max(store.bestScore || 0, finalScore);
  store.lastScore = finalScore;
  // Streak
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yKey = `${yesterday.getFullYear()}-${yesterday.getMonth()+1}-${yesterday.getDate()}`;
  if (store.lastPlayedDay === yKey) {
    store.streak = (store.streak || 0) + 1;
  } else if (store.lastPlayedDay !== today) {
    store.streak = 1;
  }
  store.lastPlayedDay = today;
  saveStorage(store);
}

function hasPlayedToday() {
  const store = loadStorage();
  return store.lastPlayedDay === getTodayKey();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCREENS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => {
    s.classList.toggle('hidden', s.id !== id);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HOME SCREEN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initHome() {
  const store = loadStorage();
  document.getElementById('home-date').textContent = formatDate(new Date());
  document.getElementById('home-streak').textContent = store.streak || 0;
  document.getElementById('home-best').textContent = store.bestScore ? store.bestScore.toLocaleString() : 'â€”';
  document.getElementById('home-played').textContent = store.played || 0;

  const played = hasPlayedToday();
  const btn = document.getElementById('btn-play');

  // Progress pips
  const pips = document.querySelectorAll('#home-progress .progress-pip');
  if (played && store.lastRoundResults) {
    store.lastRoundResults.forEach((_, i) => pips[i]?.classList.add('done'));
  }
  // Remove any stale played-state UI from previous initHome calls
  const existingBanner = document.getElementById('played-banner');
  if (existingBanner) existingBanner.remove();
  const existingViewBtn = document.getElementById('btn-view-results');
  if (existingViewBtn) existingViewBtn.remove();
  const existingCountdown = document.getElementById('comeback-msg');
  if (existingCountdown) existingCountdown.remove();
  btn.style.display = 'block';

  if (played) {
    // Hide the play button
    btn.style.display = 'none';

    // Score banner
    const banner = document.createElement('div');
    banner.id = 'played-banner';
    banner.className = 'home-played-banner';
    banner.style.maxWidth = '360px';
    banner.innerHTML = `
      <div class="home-played-icon">âœ…</div>
      <div class="home-played-text">
        <div class="home-played-label">Today's Score</div>
        <div class="home-played-score">${store.lastScore || 0} <span style="font-size:14px;color:var(--muted);font-family:'DM Mono',monospace;font-weight:400">/ 1000</span></div>
      </div>
    `;
    btn.parentNode.insertBefore(banner, btn);

    // View Results button
    const viewBtn = document.createElement('button');
    viewBtn.id = 'btn-view-results';
    viewBtn.className = 'btn-primary';
    viewBtn.style.maxWidth = '360px';
    viewBtn.textContent = 'View My Results â†’';
    viewBtn.addEventListener('click', showReview);
    btn.parentNode.insertBefore(viewBtn, btn);

    // Countdown
    const now = new Date();
    const midnight = new Date(now); midnight.setHours(24,0,0,0);
    const h = Math.floor((midnight - now) / 3600000);
    const m = Math.floor(((midnight - now) % 3600000) / 60000);
    const countdown = document.createElement('p');
    countdown.id = 'comeback-msg';
    countdown.style.cssText = 'font-size:11px;color:rgba(240,240,245,0.35);text-align:center;letter-spacing:0.05em;margin-top:6px;';
    countdown.textContent = `Next challenge in ${h}h ${m}m`;
    btn.parentNode.insertBefore(countdown, btn);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAP / GAME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initMap() {
  if (map) return; // already initialized

  mapboxgl.accessToken = MAPBOX_TOKEN;

  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [15, 25],
    zoom: 1.8,
    minZoom: 1,
    maxZoom: 12,
    projection: 'mercator',
    attributionControl: false,
    pitchWithRotate: false,
    dragRotate: false,
  });

  map.on('load', () => {
    // Boost water/land contrast: make water a visible dark navy
    ['water', 'water-shadow', 'water-depth'].forEach(id => {
      if (map.getLayer(id)) {
        try { map.setPaintProperty(id, 'fill-color', '#0d2140'); } catch(e) {}
      }
    });
    // Lighten land slightly so it reads clearly against water
    ['land', 'landcover'].forEach(id => {
      if (map.getLayer(id)) {
        try { map.setPaintProperty(id, 'background-color', '#1c1d2e'); } catch(e) {}
        try { map.setPaintProperty(id, 'fill-color', '#1c1d2e'); } catch(e) {}
      }
    });

    // Remove all symbol layers (labels/icons) so the map gives nothing away
    const layers = map.getStyle().layers;
    for (const layer of layers) {
      if (layer.type === 'symbol') {
        map.removeLayer(layer.id);
      }
    }

    // Add back major city labels â€” these help orient players without giving answers away
    const cityLabelLayout = {
      'text-field': ['get', 'name_en'],
      'text-font': ['DIN Pro Medium', 'Arial Unicode MS Regular'],
      'text-size': ['interpolate', ['linear'], ['zoom'], 1, 9, 5, 13],
      'text-max-width': 8,
      'text-padding': 4,
      'symbol-sort-key': ['-', 0, ['coalesce', ['get', 'population'], 0]],
    };
    const cityLabelPaint = {
      'text-color': 'rgba(255,255,255,0.55)',
      'text-halo-color': 'rgba(10,10,20,0.85)',
      'text-halo-width': 1.5,
    };

    // Global mega-cities: population > 5M
    map.addLayer({
      id: 'city-labels-global',
      type: 'symbol',
      source: 'composite',
      'source-layer': 'place_label',
      filter: ['all',
        ['==', ['get', 'type'], 'city'],
        ['>=', ['coalesce', ['get', 'population'], 0], 5000000],
      ],
      layout: cityLabelLayout,
      paint: cityLabelPaint,
    });

    // Europe & North America: cities > 2M (helpful for familiar regions)
    const europaNAGeoJSON = {
      type: 'Feature',
      geometry: {
        type: 'MultiPolygon',
        coordinates: [
          [[[-30,34],[50,34],[50,72],[-30,72],[-30,34]]],   // Europe
          [[[-170,15],[-50,15],[-50,75],[-170,75],[-170,15]]] // North America
        ]
      }
    };
    map.addLayer({
      id: 'city-labels-eu-na',
      type: 'symbol',
      source: 'composite',
      'source-layer': 'place_label',
      filter: ['all',
        ['==', ['get', 'type'], 'city'],
        ['>=', ['coalesce', ['get', 'population'], 0], 2000000],
        ['<',  ['coalesce', ['get', 'population'], 0], 5000000],
        ['within', europaNAGeoJSON],
      ],
      layout: cityLabelLayout,
      paint: cityLabelPaint,
    });

    map.on('click', onMapClick);
  });
}

function onMapClick(e) {
  if (document.getElementById('result-overlay').classList.contains('visible')) return;

  const { lng, lat } = e.lngLat;

  // Remove old pending marker
  if (state.pinMarker) { state.pinMarker.remove(); state.pinMarker = null; }

  // Create custom marker element
  const el = document.createElement('div');
  el.style.cssText = `
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; filter: drop-shadow(0 4px 12px rgba(232,255,71,0.5));
    animation: pin-drop 0.4s cubic-bezier(0.34,1.56,0.64,1);
  `;
  el.innerHTML = `<svg width="36" height="48" viewBox="0 0 36 48" fill="none">
    <path d="M18 0C8.06 0 0 8.06 0 18c0 13.5 18 30 18 30s18-16.5 18-30C36 8.06 27.94 0 18 0z" fill="#e8ff47"/>
    <circle cx="18" cy="18" r="8" fill="#0a0a0f"/>
  </svg>`;

  const style = document.createElement('style');
  style.textContent = `@keyframes pin-drop {
    0% { transform: translateY(-20px) scale(0.7); opacity: 0; }
    100% { transform: translateY(0) scale(1); opacity: 1; }
  }`;
  document.head.appendChild(style);

  state.pinMarker = new mapboxgl.Marker({ element: el, anchor: 'bottom' })
    .setLngLat([lng, lat])
    .addTo(map);

  state.pendingPin = { lat, lng };

  // Update UI
  document.getElementById('pin-confirm').classList.add('visible');
  document.getElementById('tap-hint').classList.add('hidden-hint');
  document.getElementById('pin-coords').textContent =
    `${lat.toFixed(3)}Â°, ${lng.toFixed(3)}Â°`;

  // Haptic
  if (navigator.vibrate) navigator.vibrate(10);
}

function lockPin() {
  if (!state.pendingPin) return;
  if (navigator.vibrate) navigator.vibrate([20, 10, 20]);

  const target = state.todayLocations[state.round];
  const [name, description, targetLat, targetLng, perfectRadius = 5] = target;
  const { lat, lng } = state.pendingPin;

  const distKm = haversineKm(lat, lng, targetLat, targetLng);
  const pts = scoreFromDistance(distKm, perfectRadius);
  state.totalScore += pts;

  state.roundResults.push({ name, pts, distKm, userLat: lat, userLng: lng, targetLat, targetLng });

  // Show answer marker
  const ansEl = document.createElement('div');
  ansEl.style.cssText = `
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    filter: drop-shadow(0 4px 12px rgba(71,200,255,0.6));
  `;
  ansEl.innerHTML = `<svg width="36" height="48" viewBox="0 0 36 48" fill="none">
    <path d="M18 0C8.06 0 0 8.06 0 18c0 13.5 18 30 18 30s18-16.5 18-30C36 8.06 27.94 0 18 0z" fill="#47c8ff"/>
    <circle cx="18" cy="18" r="8" fill="#0a0a0f"/>
  </svg>`;

  state.answerMarker = new mapboxgl.Marker({ element: ansEl, anchor: 'bottom' })
    .setLngLat([targetLng, targetLat])
    .addTo(map);

  // Draw line
  if (map.getSource('answer-line')) {
    map.removeLayer('answer-line-layer');
    map.removeSource('answer-line');
  }
  map.addSource('answer-line', {
    type: 'geojson',
    data: {
      type: 'Feature',
      geometry: {
        type: 'LineString',
        coordinates: [[lng, lat], [targetLng, targetLat]]
      }
    }
  });
  map.addLayer({
    id: 'answer-line-layer',
    type: 'line',
    source: 'answer-line',
    paint: {
      'line-color': '#47c8ff',
      'line-width': 2,
      'line-dasharray': [3, 2],
      'line-opacity': 0.6
    }
  });

  // Fit map to show both points
  const bounds = new mapboxgl.LngLatBounds()
    .extend([lng, lat])
    .extend([targetLng, targetLat]);
  map.fitBounds(bounds, { padding: 80, duration: 800 });

  // Show result overlay
  showRoundResult(name, description, distKm, pts);
}

function showRoundResult(name, description, distKm, pts) {
  document.getElementById('result-round-label').textContent =
    `Round ${state.round + 1} of ${ROUNDS_PER_GAME}`;
  document.getElementById('result-location').textContent = name;
  const qualityEl = document.getElementById('result-quality');
  qualityEl.textContent = scoreToLabel(pts);
  qualityEl.style.color = scoreToColor(pts);
  document.getElementById('result-description').textContent = description;
  document.getElementById('result-dist').textContent = formatDist(distKm);
  document.getElementById('result-pts').textContent = pts;
  document.getElementById('result-total').textContent = state.totalScore;
  document.getElementById('hud-score').textContent = state.totalScore;

  const pct = pts / MAX_SCORE_PER_ROUND * 100;
  document.getElementById('score-bar-pct').textContent = `${pts} pts`;

  setTimeout(() => {
    document.getElementById('result-overlay').classList.add('visible');
    // Animate bar
    setTimeout(() => {
      document.getElementById('score-bar-fill').style.width = pct + '%';
    }, 100);
  }, 600);

  // Update next button text
  const isLast = state.round === ROUNDS_PER_GAME - 1;
  document.getElementById('btn-next').textContent = isLast ? 'See Results â†’' : 'Next Round â†’';
}

function nextRound() {
  // Clean up map
  if (state.pinMarker) { state.pinMarker.remove(); state.pinMarker = null; }
  if (state.answerMarker) { state.answerMarker.remove(); state.answerMarker = null; }
  if (map.getLayer('answer-line-layer')) {
    map.removeLayer('answer-line-layer');
    map.removeSource('answer-line');
  }

  document.getElementById('result-overlay').classList.remove('visible');
  document.getElementById('pin-confirm').classList.remove('visible');
  document.getElementById('tap-hint').classList.remove('hidden-hint');
  document.getElementById('score-bar-fill').style.width = '0%';
  state.pendingPin = null;

  const isLast = state.round === ROUNDS_PER_GAME - 1;

  if (isLast) {
    finishGame();
    return;
  }

  state.round++;
  loadRound();
}

function loadRound() {
  const loc = state.todayLocations[state.round];
  document.getElementById('hud-round-num').textContent = state.round + 1;
  document.getElementById('clue-text').textContent = loc[0];

  // Update dots
  const dotsEl = document.getElementById('hud-dots');
  dotsEl.innerHTML = '';
  for (let i = 0; i < ROUNDS_PER_GAME; i++) {
    const dot = document.createElement('div');
    dot.className = 'hud-dot';
    if (i < state.round) dot.classList.add('done');
    else if (i === state.round) dot.classList.add('current');
    dotsEl.appendChild(dot);
  }

  // Reset map view
  map.flyTo({ center: [15, 25], zoom: 1.8, duration: 800 });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUMMARY / FINISH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function finishGame() {
  updateStats(state.totalScore);

  // Save for home screen progress
  const store = loadStorage();
  store.lastRoundResults = state.roundResults;
  saveStorage(store);

  buildSummary();
  showScreen('summary');
}

function buildSummary() {
  const today = new Date();
  document.getElementById('summary-date').textContent = formatDate(today);
  document.getElementById('final-score').textContent = state.totalScore;
  document.getElementById('share-day').textContent = `Day #${getDayNumber()}`;

  // Ring fill (conic gradient)
  const pct = state.totalScore / (MAX_SCORE_PER_ROUND * ROUNDS_PER_GAME);
  const deg = Math.round(pct * 360);
  document.getElementById('score-ring').style.background =
    `conic-gradient(var(--accent) 0deg, var(--accent2) ${deg}deg, var(--surface2) ${deg}deg)`;

  // Round breakdown
  const bk = document.getElementById('round-breakdown');
  bk.innerHTML = '';
  state.roundResults.forEach((r, i) => {
    const row = document.createElement('div');
    row.className = 'round-row';
    const color = scoreToColor(r.pts);
    row.innerHTML = `
      <div class="round-row-num">${i+1}</div>
      <div class="round-row-name">${r.name}</div>
      <div class="round-row-dist">${formatDist(r.distKm)}</div>
      <div class="round-row-score" style="color:${color}">${r.pts}</div>
    `;
    bk.appendChild(row);
  });

  // Share card
  const emojis = state.roundResults.map(r => scoreToEmoji(r.pts)).join(' ');
  document.getElementById('share-emojis').textContent = emojis;
  document.getElementById('share-score-line').textContent =
    `${state.totalScore} / 1000`;
}

function getShareText() {
  const day = getDayNumber();
  const store = loadStorage();
  const results = (state.roundResults && state.roundResults.length > 0)
    ? state.roundResults
    : (store.lastRoundResults || []);
  const score = (state.roundResults && state.roundResults.length > 0)
    ? state.totalScore
    : (store.lastScore || 0);
  const emojis = results.map(r => scoreToEmoji(r.pts)).join(' ');
  return `ğŸ“ PinDrop Day #${day}\n${emojis}\n${score} / 1000\n${window.location.origin}`;
}

async function shareScore() {
  const text = getShareText();
  if (navigator.share) {
    try {
      await navigator.share({ text });
    } catch (e) {
      if (e.name !== 'AbortError') copyToClipboard(text);
    }
  } else {
    copyToClipboard(text);
  }
}

function copyToClipboard(text) {
  navigator.clipboard?.writeText(text).then(() => {
    showToast('Score copied to clipboard!');
  }).catch(() => {
    showToast('Copy failed â€” try manually');
  });
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REVIEW MODE (already played today)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let reviewMap = null;
let reviewMarkers = [];
let reviewFocusedRound = -1; // -1 = show all

function initReviewMap(results) {
  if (reviewMap) {
    // Already initialized â€” just refresh markers
    populateReviewMap(results);
    return;
  }

  reviewMap = new mapboxgl.Map({
    container: 'review-map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [15, 25],
    zoom: 1.4,
    minZoom: 1,
    maxZoom: 10,
    projection: 'mercator',
    attributionControl: false,
    pitchWithRotate: false,
    dragRotate: false,
    interactive: true,
  });

  reviewMap.on('load', () => {
    // Strip labels
    const layers = reviewMap.getStyle().layers;
    for (const layer of layers) {
      if (layer.type === 'symbol') reviewMap.removeLayer(layer.id);
    }
    populateReviewMap(results);
  });
}

function clearReviewMarkers() {
  reviewMarkers.forEach(m => m.remove());
  reviewMarkers = [];
  if (reviewMap) {
    ['rv-lines'].forEach(id => {
      if (reviewMap.getLayer(id)) reviewMap.removeLayer(id);
      if (reviewMap.getSource(id)) reviewMap.removeSource(id);
    });
    // Remove individual line layers
    for (let i = 0; i < 5; i++) {
      if (reviewMap.getLayer(`rv-line-${i}`)) reviewMap.removeLayer(`rv-line-${i}`);
      if (reviewMap.getSource(`rv-line-${i}`)) reviewMap.removeSource(`rv-line-${i}`);
    }
  }
}

function populateReviewMap(results) {
  clearReviewMarkers();

  const bounds = new mapboxgl.LngLatBounds();
  const focus = reviewFocusedRound;

  results.forEach((r, i) => {
    if (focus !== -1 && focus !== i) return;

    const alpha = focus === -1 ? 1 : 1;

    // User marker (yellow)
    const uEl = document.createElement('div');
    uEl.style.cssText = `width:32px;height:42px;display:flex;align-items:center;justify-content:center;filter:drop-shadow(0 3px 8px rgba(232,255,71,0.5));`;
    uEl.innerHTML = `<svg width="26" height="36" viewBox="0 0 36 48" fill="none">
      <path d="M18 0C8.06 0 0 8.06 0 18c0 13.5 18 30 18 30s18-16.5 18-30C36 8.06 27.94 0 18 0z" fill="#e8ff47"/>
      <circle cx="18" cy="18" r="7" fill="#0a0a0f"/>
      <text x="18" y="22" text-anchor="middle" fill="#e8ff47" font-size="10" font-family="Syne,sans-serif" font-weight="800">${i+1}</text>
    </svg>`;
    const uM = new mapboxgl.Marker({ element: uEl, anchor: 'bottom' })
      .setLngLat([r.userLng, r.userLat])
      .addTo(reviewMap);
    reviewMarkers.push(uM);

    // Answer marker (blue)
    const aEl = document.createElement('div');
    aEl.style.cssText = `width:32px;height:42px;display:flex;align-items:center;justify-content:center;filter:drop-shadow(0 3px 8px rgba(71,200,255,0.5));`;
    aEl.innerHTML = `<svg width="26" height="36" viewBox="0 0 36 48" fill="none">
      <path d="M18 0C8.06 0 0 8.06 0 18c0 13.5 18 30 18 30s18-16.5 18-30C36 8.06 27.94 0 18 0z" fill="#47c8ff"/>
      <circle cx="18" cy="18" r="7" fill="#0a0a0f"/>
      <text x="18" y="22" text-anchor="middle" fill="#47c8ff" font-size="10" font-family="Syne,sans-serif" font-weight="800">${i+1}</text>
    </svg>`;
    const aM = new mapboxgl.Marker({ element: aEl, anchor: 'bottom' })
      .setLngLat([r.targetLng, r.targetLat])
      .addTo(reviewMap);
    reviewMarkers.push(aM);

    // Line between them
    reviewMap.addSource(`rv-line-${i}`, {
      type: 'geojson',
      data: {
        type: 'Feature',
        geometry: { type: 'LineString', coordinates: [[r.userLng, r.userLat], [r.targetLng, r.targetLat]] }
      }
    });
    reviewMap.addLayer({
      id: `rv-line-${i}`,
      type: 'line',
      source: `rv-line-${i}`,
      paint: { 'line-color': '#47c8ff', 'line-width': 1.5, 'line-dasharray': [3,2], 'line-opacity': 0.5 }
    });

    bounds.extend([r.userLng, r.userLat]);
    bounds.extend([r.targetLng, r.targetLat]);
  });

  // Fit map
  if (!bounds.isEmpty()) {
    reviewMap.fitBounds(bounds, { padding: { top: 60, bottom: 280, left: 40, right: 40 }, duration: 600, maxZoom: 7 });
  }
}

function showReview() {
  const store = loadStorage();
  const results = store.lastRoundResults;
  if (!results || results.length === 0) return;

  const score = store.lastScore || 0;
  reviewFocusedRound = -1;

  document.getElementById('review-score-num').textContent = score;
  document.getElementById('review-title').textContent = formatDate(new Date());

  // Build round chips
  const chipsEl = document.getElementById('review-rounds');
  chipsEl.innerHTML = '';

  // "All" chip
  const allChip = document.createElement('div');
  allChip.className = 'review-round-chip active';
  allChip.innerHTML = `<div class="review-chip-name">All Rounds</div><div class="review-chip-score">${score}</div>`;
  allChip.addEventListener('click', () => {
    reviewFocusedRound = -1;
    document.querySelectorAll('.review-round-chip').forEach(c => c.classList.remove('active'));
    allChip.classList.add('active');
    populateReviewMap(results);
  });
  chipsEl.appendChild(allChip);

  results.forEach((r, i) => {
    const chip = document.createElement('div');
    chip.className = 'review-round-chip';
    const shortName = r.name.split(',')[0];
    chip.innerHTML = `<div class="review-chip-name">${shortName}</div><div class="review-chip-score">${r.pts}</div>`;
    chip.addEventListener('click', () => {
      reviewFocusedRound = i;
      document.querySelectorAll('.review-round-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      populateReviewMap(results);
    });
    chipsEl.appendChild(chip);
  });

  showScreen('review');
  initReviewMap(results);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// START GAME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startGame() {
  if (hasPlayedToday()) {
    showToast("You've already played today â€” come back tomorrow!", 3000);
    return;
  }
  state = {
    round: 0,
    totalScore: 0,
    roundResults: [],
    pendingPin: null,
    pinMarker: null,
    answerMarker: null,
    answerLine: null,
    todayLocations: getTodayLocations(),
    gameComplete: false,
  };

  showScreen('game');
  initMap();
  map.once('load', () => loadRound());
  if (map._loaded) loadRound();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EVENT LISTENERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('btn-play').addEventListener('click', startGame);

document.getElementById('btn-how').addEventListener('click', () => {
  showToast('Tap the map â†’ Lock It In â†’ 5 rounds, score by accuracy!', 3000);
});

document.getElementById('btn-lock').addEventListener('click', lockPin);

document.getElementById('btn-cancel-pin').addEventListener('click', () => {
  if (state.pinMarker) { state.pinMarker.remove(); state.pinMarker = null; }
  state.pendingPin = null;
  document.getElementById('pin-confirm').classList.remove('visible');
  document.getElementById('tap-hint').classList.remove('hidden-hint');
});

document.getElementById('btn-next').addEventListener('click', nextRound);

document.getElementById('btn-share').addEventListener('click', shareScore);

document.getElementById('btn-home-from-summary').addEventListener('click', () => {
  initHome();
  showScreen('home');
});

document.getElementById('btn-share-review').addEventListener('click', shareScore);

document.getElementById('btn-back-home-review').addEventListener('click', () => {
  initHome();
  showScreen('home');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

mapboxgl.accessToken = MAPBOX_TOKEN;
initHome();
showScreen('home');
</script>
</body>
</html>
